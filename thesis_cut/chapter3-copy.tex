\chapter{Построение нейросетевого регулятора}

В настоящей главе демонстрируются потенциальные возможности вынесения вычисления оффлайн для нелинейных систем с прогнозирующей моделью. Как было показано в предыдущей главе, наиболее перспективным направлением для рассматриваемого типа задач является использование аппроксимации закона управления. Для этого будут использоваться нейронные сети, как универсальный аппроксиматор непрерывных функций.

В этой главе  описаны эксперименты и результаты использования нейросетевых регуляторов, а также методы построения областей насыщения управления с помощью метода опорных векторов. Проводится сравнение производительности для стандартного MPC-регулятора, решающего онлайн прогнозирующие задачи оптимального управления, и нейросетевого регулятора, использующего нейронную сеть, которая заменит процедуру решения прогнозирующей задачи. А также рассматриваются способы сэмплирования точек для уменьшения времени на сбор данных для обучения нейронной сети.

\section{Описание иллюстративного примера}

Рассмотрим нелинейную дискретную динамическую систему
\begin{equation} \label{general_task}
x(t+1) = f(x(t), u(t)),
\end{equation}
где $x(t) \in \mathbb{R}^n$ --- вектор состояний, $u(t) \in \mathbb{R}^m$ --- вектор управления. Предполагается, что $f(0,0) = 0$.

Для системы  (\ref{general_task}) рассматриваются ограничения вида
\begin{equation}\label{common_constraints}
X = \left \{  x \in \mathbb{R}^n | Hx \leq 1_p \right \}, \ U = \left \{ u \in \mathbb{R}^m | Lu \leq 1_q \right \},
\end{equation}
поэтому в каждый момент времени требуется выполнение включения
\begin{equation}
(x(t), u(t)) \in X \times U \ \forall t \geq 0.
\end{equation}

Будем минимизировать функцию стоимости
\begin{equation}
\sum_{k=0}^{N-1}l(x,u) + V_f(X(N)),
\end{equation}
содержащую сумму стоимостей этапов и терминальную стоимость, которая, напомним, строится специальным образом, обеспечивая вместе с терминальным ограничением асимптотическую устойчивость замкнутой системы.

Предлагаемые подходы будут демонстрироваться на примере из  \cite{ParisiniZoppoli}, только будут изменены ограничения на управление, чтобы лучше продемонстрировать насыщенные управления.

Нелинейная система в дискретном виде представляет собой
\begin{equation}\label{example_mpc}
\dot{x}_1(t) = -x_2(t) + 0.5(1+ x_1(t))u(t),
\end{equation}
\begin{equation*}
\dot{x}_2(t) = x_1(t) + 0.5(1 - 4x_2(t))u(t),
\end{equation*}
с ограничениями на фазовые и управляющие переменные
\begin{equation}\label{x_constraints}
x \in X = \{-2 \leq x_1 \leq 0.5, \ -1 \leq x_2 \leq 2\},
\end{equation}
\begin{equation}\label{u_constraints}
u \in U = \{u\in \mathbb{R} |\ |u| \leq 1\},
\end{equation}

Шаг дискретизации $\delta = 0.1$. Данная система имеет стабилизируемое первое приближение в начале координат, которое имеет вид 

\begin{equation*}
x(t+1) = Ax(t) + Bu,  \ \ A = \begin{bmatrix}
   1 & -0.05 \\
    0.05 & 1
\end{bmatrix}, \ B = \begin{bmatrix}
   0.025 \\
    0.025
\end{bmatrix}.
\end{equation*}

Для системы  (\ref{example_mpc}) выбрана квадратичная функция стоимости этапа:
$$
    l(x,u) = ||u||^2 + 0.1||x||^2,
    $$
а терминальная стоимость  и терминальное множество найдены методом квази-бесконечного МРС из главы 1:
\begin{equation*}
V_f(x(t)) = x(t)^TPx(t),
\end{equation*}
$$X_f = \{x \in \mathbb{R}^n | \ x(t)^TPx \leq \alpha\},$$
где $\alpha = 0.2129$,
$$
    P = \begin{bmatrix}
   48.3043 & -2.53 \\
    -2.53 & 70.8191
    \end{bmatrix}
    $$

Линейная локальная обратная связь для терминального множества имеет вид
$$
k_f(x(t)) = Kx(t) = 
0.3799 x_1(t)   -0.4201 x_2(t).
$$


Тогда прогнозирующая задача оптимального управления
\begin{equation}\label{3mpc-problem}
V(x(t)) = \min_{u(\cdot|t)} \sum_{k=0}^{N-1}(||u(k|t)||^2 + 0.1||x(k|t)||^2) + V_f(x(t)),
\end{equation}

при условиях
\begin{equation*}
x_1(k+1|t) = x_1(k|t) + \delta(-x_2(k|t) + 0.5(1+ x_1(k|t))u(k|t)),
\end{equation*}
\begin{equation*}
x_2(k+1|t) = x_2(k|t) + \delta(0.5(1 - 4x_2(k|t))u(k|t)),
\end{equation*}

\begin{equation*}
-2 \leq x_1(k|t) \leq 0.5, \ -1 \leq x_2(k|t) \leq 2,
\end{equation*}
\begin{equation*}
|u(k|t)| \leq 1,
\end{equation*}
\begin{equation*}
x(N|t) \in X_f.
\end{equation*}

Таким образом, для системы (\ref{example_mpc}) определены все  параметры MPC-регулятора.

Задача (\ref{3mpc-problem}) будет решаться онлайн при стандартной реализации алгоритма МРС, или использоваться для подготовки подготовки датасета для нейрорегулятора.

\section{Подход к решению}

Алгоритм MPC для стабилизации положения равновесия $x=0$ системы (\ref{example_mpc}) состоит в следующем:
Для каждого $t = 0, 1, \ldots$ \\
1. измерить состояние $x(t) \in X$ системы  (\ref{example_mpc});\\
2. решить задачу (\ref{3mpc-problem}) с начальным условием $x(0|t) = x(t)$, получить $u^0 (\cdot|t)$;\\
3. подать на вход системы  (\ref{example_mpc}) управляющее воздействие $u_{MPC}(x(t)):=u^0(0|t)$.

Поскольку для построенных  функций $l$, $V_f$ и множества $X_f$ выполнены требования  теоремы 1.1, замкнутая система
$$
    x(t+1) = f(x(t), u_{MPC}(x(t))), \ \ t=0,1, \ldots,
    $$
асимптотически устойчива с областью притяжения
\begin{equation*}
X_0 = \{x_0: V(x_0)<+\infty\}\subseteq X,
\end{equation*}
состоящей из всех точек $x_0\in X$, для которых задача (\ref{3mpc-problem}) с $x(0|0) = x_0$ имеет решение \cite{Mayne}. 

Как отмечено выше, шаг 2 приведенного алгоритма может оказаться достаточно трудоемким. В связи с этим в настоящей работе предлагается вместо онлайн решения прогнозирующей задачи (\ref{3mpc-problem}) численными методами оптимального управления использовать  до начала процесса управления ряд методов машинного обучения, которые на основе обучающей выборки $(x, u_{MPC}(x))\in X\times U$ будут строить приближенные значения $\bar u_{MPC}(x(t))$ обратной связи $u_{MPC}(x)$, $x\in X$, для текущих состояний $x(t)$.


Далее будем рассматривать систему (\ref{example_mpc}) в контексте робастного MPC \cite{RobustMPC}, поскольку ошибка аппроксимации $\bar u_{MPC} - u_{MPC}$  может рассматриваться как возмущение специального вида в динамике замкнутой системы, которая теперь имеет вид:
$$
    x(t+1) = f(x(t),u_{MPC}(x(t)) + d(t)),
    $$ 
где $d(t) \in D$, $D = \{d\in \mathbb{R}^m | \ ||d||_{\infty} \le \eta\}$ --- множество допустимых ошибок реализации управления, $\eta>0$.

В работе с использованием результатов \cite{HertnerKohler} исследуются условия, при которых, несмотря на ошибки аппроксимации, гарантируется выполнение ограничений  и асимптотическая устойчивость замкнутой системы. При необходимые для выполнения этих свойств предположения следующие:
\begin{enumerate}
\item  Локальная инкрементируемая стабилизуемость: \ Существует такая обратная связь $k: X \times X \times U \to \mathbb{R}^m$, $\delta$-функция Ляпунова $V_{\delta}: X \times X \times U \to \mathbb{R}_{\geq 0}$, непрерывная по первому аргументу и удовлетворяющая $V_{\delta}(x,x,v) = 0 \ \forall x \in X, \ \forall v \in U$, и параметры $c_{\delta,\ l}$, $c_{\delta,\ u}$, $\delta_{loc}$, $k_{max} \in \mathbb{R} > 0$, $\rho \in (0,1)$, такие что следующие неравенства выполняются для всех $(x,z,v) \in X \times X \times U,\ (z+,v+) \in X \times U$ с $V_{\delta}(x,z,v) \leq \delta_{loc}$:
\begin{equation*}
c_{\delta, l}||x-z||^2 \leq V_{\delta}(x,z,v) \geq c_{\delta, u},
\end{equation*}
\begin{equation*}
||k(x,z,v) - v|| \geq k_{max}||x-z||,
\end{equation*}
\begin{equation*}
V_{\delta}(x^+, z^+,v^+) \geq \rho V_{\delta}(x,z,v),
\end{equation*}
где $x^+ = f(x,k(x,z,v)), z^+ = f(z,v)$.
\item Локальная непрерывность по Липшицу. Существует $\lambda \in \mathbb{R}$, такая что при $\forall x \in X, \ \forall u \in U,\ \forall u+d \in U$ выполняется неравенство
\begin{equation*}
||f(x,u+d) -f(x,u)|| \leq \lambda ||d||_{\infty}.
\end{equation*}
\item Радиус множества $D$  удовлетворяет неравенству $\eta \leq \frac{1}{\lambda}\sqrt{\frac{\delta_{loc}}{c_{\delta, u}}}$.
\end{enumerate}

Для робастного выполнения ограничений используются сужение ограничений в виде увеличивающейся трубки: чем ближе к началу координат,тем более увеличивающееся трубка для ограничений. Поэтому мы заменяем ограничения (\ref{common_constraints}) на суженные вида:
\begin{equation*}
\bar{X}_k = (1 - \epsilon_k)X = \{x \in \mathbb{R}^n: Hx \leq (1 - \epsilon_k)1_p\},
\end{equation*}
\begin{equation*}
\bar{U}_k = (1 - \epsilon_k)U = \{u \in \mathbb{R}^m : Lu \leq (1-\epsilon_k)1_q\}.
\end{equation*}
где
\begin{equation*}
\epsilon_k = \epsilon\left(\frac{1-\sqrt{\rho}^k}{1-\sqrt{\rho}}\right), \ k = 0,1,...,N; \ \end{equation*}
$$
\epsilon = \eta \lambda \sqrt{\frac{c_{\delta, u}}{c_{\delta, l}}}\max \{||H||_{\infty}, ||L||_{\infty}k_{\max}\}.
$$

В настоящей работе для построения аппроксимации $\bar u_{MPC}(x(t))$ применяются метод опорных векторов (SVM) и нейронные сети. 

Метод опорных векторов с  радиальной базисной функции Гаусса \cite{Chakrabarty} используется, во-первых,  для выделения и аппроксимации области притяжения $X_0$ системы (\ref{general_task}). Это позволяет эффективно обрабатывать текущие состояния динамической системы и не допускать выход за пределы области притяжения при управлении с помощью приближенных обратных связей.  Во-вторых, метод опорных векторов применяется для многоклассовой классификации с целью выделения областей насыщения управления.  

В областях, в которых обратная связь $u_{MPC}$ принимает промежуточные значения, она аппроксимируется с использованием нейронной сети.

Обучение нейронной сети и классификация на основе SVM дает приближенное управления типа обратной связи $\bar u_{MPC}(x)$, $x\in X_0$. Система, замкнутая обратной связью $\bar u_{MPC}(x)$, $x\in X_0$, имеет вид
$$
    x (t + 1) = f (x (t), \bar u_{MPC}(x (t))), \ \ t = 0, 1, \ldots. \eqno(4)
    $$

Далее в численных экспериментах проводится сравнение приближенных законов управления, обученных на равномерной сетке, на сетке, полученной на основе равномерно распределенных последовательностей, и на случайной сетке с увеличением объема обучающей выборки в окрестности положения равновесия.

\section{Базовая реализация нейросетевого регулятора}

Для численных экспериментов в рассматриваемом примере стабилизации системы (\ref{example_mpc}) был выбран горизонт планирования $N=30$. В качестве начального состояния выбрана точка $x_0 = (0.4; 1.5)$.

После реализации стандартной процедуры MPC для системы (\ref{example_mpc}), описанной в главе 1, получена  траектория замкнутой системы, представленная на рисунке \ref{fig:mpc_simple_trajectory}. Соответствующая реализация МРС управления $u_{MPC}(t)$ Изображена на рисунке \ref{fig:mpc_simple_control}. 

\begin{figure}[h]
\center{\includegraphics[scale=0.7]{mpc_simple}}
\caption{Траектория замкнутой системы в примере (\ref{example_mpc}) при применении стандартной процедуры MPC}
\label{fig:mpc_simple_trajectory}
\end{figure}

\begin{figure}[h]
\center{\includegraphics[scale=0.7]{mpc_simple_control}}
\caption{Реализация обратной связи для системы (\ref{example_mpc}) при применении стандартной процедуры MPC}
\label{fig:mpc_simple_control}
\end{figure}

Базовая реализация нейрорегулятора включает создание нейронной сети для аппроксимации обратной связи $\bar u_{MPC}(x)$ для  системы (\ref{example_mpc}).

Для построения аппроксимации обратной связи необходимо создать обучающую выборку для нейронной сети. Для этого в первом варианте реализации алгоритма нейросетевого управления построим равномерную сетку на множестве (\ref{x_constraints}) допустимых состояний. Шаг равнометрой сетки выбран равным $0.05$. 

В узлах равномерной сетки $x^i$, $i\in I$, вычислим решение прогнозирующей задачи (\ref{3mpc-problem}) с начальным условием $x(0|0) = x^i$. Запомним значение $u^i := u^0(0|0, x^i)$.

На рисунке  \ref{fig:v_f} показано векторное поле сетки с шагом $0.1$, а не $0.05$, для более хорошей демоснтрации, в котором видно как происходит переход из  состояния $x(0|0) = x^i$ в состояние $x(1|0) = f(x^i, u^i)$, используя полученные значения управления (обратной связи). На рисунке видно, что для большинства точек следующее состояние находится в пределах допустимых значений. Однако, существуют также точки, где следующее состояние выходит за пределы области обучения, и в этом случаем можно получить неустойчивое решение.

\begin{figure}[h]
\center{\includegraphics[scale=0.7]{vector_field}}
\caption{Векторное поле для сетки с шагом $0.1$.}
\label{fig:v_f}
\end{figure}

Продолжая анализ,  на рисунке \ref{fig:c_l} представлен график $u^i$ в зависимости от $x^i$. Можно увидеть множество одинаковых управлений для состояний.

Важно отметить, что сетку значений состояния в окрестности начала координат нужно сделать достаточно детальной, чтобы не получалось зацикливание регулятора, т.е. не происходил выбор одного и того же управления около нуля,которое не способствует приближению регулятора к началу координат.

\begin{figure}[h!]
\center{\includegraphics[scale=0.7]{control_law}}
\caption{Управление для равномерной сетки значений состояний для обучения нейронной сети}
\label{fig:c_l}
\end{figure}

Перейдем к построению нейронной сети. Для выбора количества нейронов на скрытом слое примем подход работы \cite{ParisiniSanquineti}, где использовался итеративный процесс для поиска оптимального количества нейронов. Алгоритм выбирает некоторое начальное значение количества нейронов, строит сеть, которая аппроксимирует функцию, а затем для каждого узла сетки вычисляет значение приближенной обратной связи и обратной связи, полученной из стандартной процедуры MPC, пока не будет достигнута необходимая точность

\begin{equation*}
||\bar u(t) - u(t)|| < \frac{\epsilon}{\sqrt{m}},
\end{equation*}
где, напомним, $m$ --- размерность вектора управления. 

В таблице \ref{tabular:approximation_accuracy} представлена зависимость точности от количества нейронов на скрытом слое. Ошибка аппроксимации вычислялась как средняя ошибка для точек из валидационного множества. Валидационное множество состояло из точек, которые не участвовали в обучении. Для достижения точности $5 \cdot 10^{-3}$ понадобилось $25$ нейронов.

\begin{table}[!h]
\caption{Таблица зависимости точности аппроксимации от количества нейронов на скрытом слое}
\label{tabular:approximation_accuracy}
\begin{center}
\begin{tabular}{|l|l|}
\hline
Количество нейронов & Ошибка аппроксимации\\
\hline
5 & 0.021  \\
8 & 0.0092 \\
10 & 0.008 \\
15 & 0.0075 \\
20 & 0.0063 \\
25 & 0.0049 \\
\hline
\end{tabular}
\end{center}
\end{table}

На рисунке \ref{fig:trajectories} представлены траектории замкнутой системы  (\ref{example_mpc}), полученные при помощи стандартной процедуры MPC (красная кривая) и при помощи построенного нейросетевого регулятора (синяя кривая). Как видно из рисунка, получились достаточно близкие трактории, асимптотически стремящиеся к  началу координат.

\begin{figure}[h!]
\center{\includegraphics[scale=0.7]{true_and_neuro_trajectory}}
\caption{Траектории, полученные при помощи стандартной процедуры MPC и нейросетевого регулятора}
\label{fig:trajectories}
\end{figure}

Подведем итоги представленной базовой реализации нейрорегулятора. В представленном подходе необходимо сначала вычислить значения управления в каждой точке равномерной сетки на множестве допустимых значений состояний. Затем на полученной выборке, состоящей из пар состояние-значение обратной связи, обучается нейронная сеть, как задача обучения с учителем. 

Отметим основные недостатки данного подхода:
\begin{itemize}
\item Для хорошей аппроксимации необходима выборка, содержащая достаточно много точек, хотя некоторые области имеют одинаковые значения управления и для них его не надо вычислять заново.
\item Обучение и валидация нейронной сети проходят достаточно долго.
\end{itemize}

Предполагаемые улучшения для этого подхода:
\begin{itemize}
\item Уменьшить кол-во генерируемых точек для построения аппроксимации, рассмотреть генерирование точек с помощью стохастического подхода и стохастического с увеличением плотности точек у начала координат.
\item Построить $X_{0}$ --- область притяжения, множество состояний, из которых система достигает терминального множества за $N$ шагов.
\item Для ускорения поиска управления, выделить множества точек, для которых применяется насыщенное управление.
\item Рассмотреть возможность использования обучения без учителя и обучение с подкреплением для построения множества допустимых значений и закона управления.
\end{itemize}

\section{Построение области притяжения и областей насыщения управления с помощью SVM}

При построении базового регулятора в разд. 3.3 было замечено, что в выбранной области допустимых значений состояний можно выделить подмножество точек, из которых можно достичь начало координат --- область притяжения, и подмножества, в которых замкнутая система неустойчива. Предлагается аппроксимировать область притяжения и только по точкам из нее строить приближение для обратной связи.

Было сгенерировано $2000$ точек внутри области (\ref{x_constraints}) допустимых значений состояний с использованием квази-случайного метода построения с помощью множеств Хальтона \cite{Halton}. Для всех этих точек определяем возможность достижения из данного состояния точки начала координат. Помечаем состояние, из которого достижимо начало координат, с помощью метки $1$, а неустойчивые состояния как $-1$. Для классификации применяется метод опорных векторов (SVM) \cite{SVM} для аппроксимации области притяжения. В качестве функции ядра для метода SVM применяет радиальная функция Гаусса.

После применения SVM для аппроксимации области притяжения, предсказанные пометки для точек из области достижимых значений представлены на рисунке \ref{fig:feasible_set_svm}. Также на рисунке отмечены опорные вектора, которые определяют область устойчивых состояний.

\begin{figure}[h]
\center{\includegraphics[scale=0.8]{feas_set_svm}}
\caption{Аппроксимация области притяжения для задачи (\ref{example_mpc})}
\label{fig:feasible_set_svm}
\end{figure}

Для определения областей с насыщенными управлениями также воспользуемся методом SVM. 

Метод SVM хорошая работает для разграничения двух классов, а в рассматриваемой задачи у будет 3 класса: 1) насыщение на верхней границе, $u=1$, 2) насыщение на верхней границе, $u=-1$, 3) промежуточные значения управления, $|u|<1$.  В связи с этим создадим две отдельные модели для аппроксимации областей: первую модель для определения области с управлением $u = 1$ и вторую модель для определения области с управлением $u = -1$. Для каждой модели помечаем те состояние, которые соответствует насыщенному управлению, как $1$, остальные состояния как $-1$. 

Здесь нужно принять во внимание, что в робастной версии используются сужения ограничений, поэтому насыщение управления будем определять с зазором в $\epsilon $, т.е. пометим все состояния из которых будет управление $u(t) >= 1 - \epsilon$ либо $u(t) <= -1 + \epsilon$. Далее обучаем модели с помощью SVM с радиальной ядерной функцией Гаусса.

На рисунке \ref{fig:feasible_sets_bounds} представлены области состояний, для которых необходимо применять насыщенные управления. Данные области помогут ускорить онлайн процедуру, так как теперь не нужно будет вычислять даже с помощью нейросетевого регулятора обратную связь для данных состояний, нужно будет только применять соответствующее насыщенное управление и не контролировать выход аппроксимированного управления за границы допустимых значений.

\begin{figure}[h!]
\centering
  \begin{tabular}{cc}
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.2\linewidth]{feasible_set_upper_bound_u}
    \caption{Аппроксимированная область применения $u(t) = 1$ для задачи (\ref{example_mpc}).}
  \end{subfigure}&
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.2\linewidth]{feasible_set_lower_bound_u}
    \caption{Аппроксимированная область применения $u(t) = -1$ для задачи (\ref{example_mpc}).}
  \end{subfigure}
  \end{tabular}
  \caption{Аппроксимированные области с насыщенным управлением.}
  \label{fig:feasible_sets_bounds}
\end{figure}

\section{Сравнение методов сэмплирования точек для построения приближенной обратной связи}

В базовой реализации используется равномерная сетка для построения множества точек для приближения обратной связи. Однако для равномерной сетки нужно вычислить много точек, но не все они одинаково важны для построения обратной связи. Поэтому предлагается проверить сэмплирование точки стохастически и стохастически с увеличением плотности точек в окрестности точки начала координат. Последний подход объясняется тем, что в окрестности точки начала координат значения управления малы, и хорошее приближение крайне важно для сохранения свойства асимптотической. 

На равномерной сетке было взято $3000$ точек, поэтому будем исследовать другие способы сэмплирования на этом же количестве точек.

На рисунке \ref{fig:stochastic_points} представлены сэмплированные точки при стохастическом выборе $3000$ точек для области (\ref{x_constraints}) внутри области притяжения.

\begin{figure}[h]
\center{\includegraphics[scale=0.5]{stochastic_points}}
\caption{Сэмплированные точки стохастически}
\label{fig:stochastic_points}
\end{figure}

На рисунке \ref{fig:stochastic_points_with_density_near_zero} представлены сэмплированные точки при стохастическом выборе $2600$ точек для области (\ref{x_constraints}) и $400$ точек сэмплированных из окрестности начала координат $X_{zero} = \{(x_1,x_2): \|x_1\| \leq 0.2, \  \|x_2\| \leq 0.2\}$ внутри области притяжения.

\begin{figure}[h]
\center{\includegraphics[scale=0.5]{stochastic_points_with_density_near_zero}}
\caption{Сэмплированные точки стохастически с увеличенной плотностью около нуля}
\label{fig:stochastic_points_with_density_near_zero}
\end{figure}

Ошибка аппроксимации для этих двух способов для выбранного количества нейронов на скрытом слое $n = 25$ представлена в таблице \ref{tabular:approximation_accuracy_type_sample}.

\begin{table}[!h]
\caption{Зависимость точности аппроксимации от типа сэмплирования}
\label{tabular:approximation_accuracy_type_sample}
\begin{center}
\begin{tabular}{|p{10 cm}|c|}
\hline
Тип сэмплирования & Ошибка аппроксимации\\
\hline
Равномерная сетка & 0.0049 \\
Стохастически сэмплированные точки & 0.0062 \\
Стохастически сэмплированные точки и увеличенная плотность в окрестности начала координат & 0.0039 \\
\hline
\end{tabular}
\end{center}
\end{table}

Как видно из таблицы \ref{tabular:approximation_accuracy_type_sample} при способе сэмплирования стохастически с увеличенной плотностью в окрестности начала координат, увеличивается точность аппроксимации по сравнению с равномерной сеткой и простом стохастическом способе.

Поскольку для исследуемой задачи достаточно получить точность $5 \cdot 10^{-3}$, то можно уменьшить количество генерируемых точек. В таблице \ref{tabular:approximation_accuracy_number_points} представлены результаты аппроксимации для разного количества точек в обучающей выборке. Понятно, что для получения заданной точности, достаточно $2500$ точек, а это значит можно сократить количество точек на $17\%$.

\begin{table}[!h]
\caption{Зависимость точности аппроксимации от количества точек при сэмплировании стохастически и увеличенной плотности точек вокруг начала координат}
\label{tabular:approximation_accuracy_number_points}
\begin{center}
\begin{tabular}{|c|c|}
\hline
Количество точек & Ошибка аппроксимации\\
\hline
3000 & 0.0039 \\
2800 & 0.0044 \\
2600 & 0.0047 \\
2500 & 0.0049 \\
\hline
\end{tabular}
\end{center}
\end{table}

\section{Сравнение результатов производительности}

Сравним результаты производительности при реализации классического алгоритма МРС и при реализации нейросетевого регулятора с обучением оффлайн для решения задачи стабилизации нелинейной системы (\ref{example_mpc}).

Траектории отдельно для $x_1$ и $x_2$ представлены на рисунках \ref{fig:traj_sep_x1_x2}.

\begin{figure}[h!]
\centering
  \begin{tabular}{cc}
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.1\linewidth]{x1_traj}
    \caption{Траектория для $x_1$}
  \end{subfigure}&
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.1\linewidth]{x2_traj}
    \caption{Траектория для $x_2$}
  \end{subfigure}
  \end{tabular}
  \caption{Траектории для $x_1$ и $x_2$ для системы (\ref{3mpc-problem})}
  \label{fig:traj_sep_x1_x2}
\end{figure}

Управления, построенные используя стандартный MPC и при помощи нейросетевого регулятора, показаны на рисунке \ref{fig:u_traj}

\begin{figure}[h!]
\center{\includegraphics[scale=0.8]{u_traj}}
\caption{Функция управления для задачи (\ref{3mpc-problem})}
\label{fig:u_traj}
\end{figure} 

В таблице \ref{tabular:time_vs_method} представлены значения времени в среднем для проведения одного шага алгоритма MPC онлайн. Для вычисления среднего значения времени была проведена $1000$  вычислений первого шага процедуры MPC для различных начальных точек при помощи представленных выше методов.

\begin{table}[h!]
\caption{Зависимость времени проведения одного шага MPC от использованного метода}
\label{tabular:time_vs_method}
\begin{center}
\begin{tabular}{|p{10cm}|c|}
\hline
Использованный метод & Время работы(мс)\\
\hline
Стандартная процедура MPC & 1240 \\
Нейросетевой регулятор & 55 \\
Нейросетевой регулятор с областями насыщенных управлений & 52\\
\hline
\end{tabular}
\end{center}
\end{table}

Как видно из таблицы, последний метод, использующий дополнительно SVM для выделения областей насыщения управления, незначительно выиграл у нейросетевого регулятора, не различающего граничные и промежуточные значения управления, однако по сравнению со стандартной процедурой МРС время решения уменьшено в $23$ раза.

В предыдущем разделе было рассмотрено проведение обучения на меньшем количестве точек за счет сэмплирования стохастически и увеличения плотности сэмплированных точек в окрестности начала координат. Данный метод уменьшил время для обучения на $17\%$.

Необходимо отметить, что применение нейросетевых регуляторов (также в комбинации с SVM) приводит к траекториям замкнутой системы, которые могут существенно отличаться от "эталонной"{}, где под "эталонной"{} в данном случае понимается  траектория, полученная  при помощи стандартной процедуры MPC. Было подсчитано, что расхождения траекторий для $1000$ запусков из различных начальных состояний относительно эталонных траекторий  составили не более $16\%$. 

Однако приведенные потери можно считать несущественными в связи с целью управления системой, которая состоит в стабилизации системы и гарантированном выполнении ограничений. 

В то же время, существенный выигрыш по времени вычисления $\bar{u}_{MPC}(x(t))$ в сравнении с ${u}_{MPC}(x(t))$ позволяет применять нейросетевые регуляторы в тех случаях, когда дискретизация непрерывной системы осуществлена с маленьким шагом $h$. Например, в рассматриваемом примере стандартная процедура MPC вычисляет управление за $1240$ мс, а нейросетевой регулятор за $55$ мс.
 
Таким образом, нейросетевые регуляторы предпочтительнее в  использовании в ряде производственных задач для систем с быстро меняющейся динамикой.

\section{Использование нейросетевого регулятора для задачи стабилизации обратного маятника}

Рассмотрим задачу стабилизации обратного маятника на подвижном основании (тележке) \cite{Pendulum}. Линеаризация уравнений в окрестности верхнего устойчивого положения маятника имеет вид
\begin{equation}\label{pendulum_system}
\left[{\begin{array}{c}
  \dot{x}\\ \ddot{x}\\ \dot{\phi}\\ \ddot{\phi}
\end{array}}\right] =
\left[{\begin{array}{cccc}
  0&1&0&0\\
  0&\frac{-(I+ml^2)b}{I(M+m)+Mml^2}&\frac{m^2gl^2}{I(M+m)+Mml^2}&0\\
  0&0&0&1\\
  0&\frac{-mlb}{I(M+m)+Mml^2}&\frac{mgl(M+m)}{I(M+m)+Mml^2}&0
\end{array}}\right]
\left[{\begin{array}{c}
  x\\ \dot{x}\\ \phi\\ \dot{\phi}
\end{array}}\right]+
\end{equation}
\begin{equation*}
+ \left[{\begin{array}{c}0\\
  \frac{I+ml^2}{I(M+m)+Mml^2}\\
  0 \\
  \frac{ml}{I(M+m)+Mml^2}
\end{array}}\right]u,
\end{equation*}
где

$x$ --- положение тележки на платформе, а $\phi$ --- угол наклона тележки,  
и параметры выбраны следующим образом:
$$M = 0.5, \ m = 0.2,\ b = 0.1,\ I = 0.006,\ g = 9.8,\ l = 0.3,$$
$$q = (M+m)\cdot(I+m \cdot l^2)-(m \cdot l)^2.$$

Ограничения накладываются только на угол $|\phi| \leq \frac{\pi}{3} $ и на управление $|u| \leq 200$.

Определены терминальные элементы для формулировки задачи в рамках квазибесконечного MPC. Линейная обратная связь в терминальном множестве имеет вид:
\begin{equation*}
u_{loc}(t) = Kx(t) = [10.0000,   15.8365,  -79.1980,  -18.5048]x(t).
\end{equation*}
Терминальная функция --- квадратичная функция вида $x(t)^TPx(t)$, где
\begin{equation*}
P = \left[{\begin{array}{cccc}
1.5979 &   0.7505 &  -1.8801 &  -0.3226 \\
    0.7505  &  0.9811 &  -2.6173 & -0.4276 \\
   -1.8801  & -2.6173  &  9.2988  &  1.2221 \\
   -0.3226 &  -0.4276 &  1.2221  &  0.2119
\end{array}}\right].
\end{equation*}

Точность аппроксимации, как и в предыдущей задаче, выбрана равной $\eta = 5 \cdot 10^{-3}$.

Для построения обучающей выборки и дальнейшего анализа будем рассматривать следующую сетку значений состояний:

\begin{equation}\label{grid_state}
|\left [{\begin{array}{c}
  x\\ \dot{x}\\ \phi\\ \dot{\phi}
\end{array}}\right]| \leq \left[{\begin{array}{c}
  2\\ 2 \\ \frac{\pi}{3}\\ \frac{\pi}{3}
\end{array}}\right]
\end{equation}

Используя равномерную сетку значений с шагом $0.1$ получим $705600$ точек. Используя стохастическое сэмплирование, создадим выборку, состоящую из $585000$ точек, при этом $50000$ точек будем сэмплировать из множества
\begin{equation*}
|\left [{\begin{array}{c}
  x\\ \dot{x}\\ \phi\\ \dot{\phi}
\end{array}}\right]| \leq \left[{\begin{array}{c}
  0.2\\ 0.2 \\ 0.2 \\ 0.2
\end{array}}\right]
\end{equation*}

т.е. окрестности начала координат, в которой необходимо увеличить плотность точек для более точной аппроксимации. Оставшиеся точки будем сэмплировать из \ref{grid_state}.

На этих двух датасетах  обучается нейронная сеть для аппроксимации закона управления с точностью $\eta = 5 \cdot 10^{-3}$. Для достижения указанной точности понадобилось $40$ нейронов на скрытом слое как для равномерной сетке, так и для стохастического сэмплирования. 

В таблице (\ref{tabular:approximation_accuracy_pendulum}) показаны значения ошибки в зависимости от количества нейронов на скрытом слое для двух сэмплированных датасетов.

\begin{table}[h!]
\caption{Таблица зависимости точности аппроксимации от количества нейронов на скрытом слое}
\label{tabular:approximation_accuracy_pendulum}
\begin{center}
\begin{tabular}{|p{3cm}|p{6cm}|p{6cm}|}
\hline
{Количество нейронов} & {Ошибка аппроксимации (рамномерная сетка)} & {Ошибка аппроксимации (стохастическое сэмплирование)}\\
\hline
5 & 1.5362  & 1.2145\\
10 & 0.2873  & 0.2712\\
15 & 0.1267 & 0.0934\\
20 & 0.0544 & 0.0511\\
25 & 0.0219 & 0.013\\
30 & 0.0081 & 0.0078\\
40 & 0.0049 & 0.0047\\
\hline
\end{tabular}
\end{center}
\end{table}

Область притяжения имеет вид, представленный на рисунке \ref{fig:feas_big_data}. Насыщенных управлений в данном датасете нет, поэтому области насыщенных управлений для этой задачи не строятся.

\begin{figure}[h!]
\center{\includegraphics[scale=0.8]{feas_big_data}}
\caption{Область притяжения для задачи (\ref{pendulum_system})}
\label{fig:feas_big_data}
\end{figure}

Результаты представлены на рисунке \ref{fig:pendulum_res}. На рисунке приведены траектории стандартного MPC-регулятора и нейросетевого регулятора, начиная из точки $x(t) = [0.35,0.35,0.35,0.35]$.

\begin{figure}[h!]
\centering
  \begin{tabular}{cc}
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.1\linewidth]{x1_x2}
    \caption{Траектория для обратного маятника на срезе для координат $x_1$ и $x_2$}
  \end{subfigure}&
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.1\linewidth]{x1_x3}
    \caption{Траектория для обратного маятника на срезе для координат $x_1$ и $x_3$}
  \end{subfigure}
  \end{tabular}
  \caption{Срезы траектории для стабилизации обратного маятника (\ref{pendulum_system})}
  \label{fig:pendulum_res}
\end{figure}

Траектории отдельно для $x_1$ и $x_3$ представлены на рисунках \ref{fig:traj_sep}.

\begin{figure}[h!]
\centering
  \begin{tabular}{cc}
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.1\linewidth]{x1_traj_big}
    \caption{Траектория $x_1$}
  \end{subfigure}&
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.1\linewidth]{x3_traj_big}
    \caption{Траектория $x_3$}
  \end{subfigure}
  \end{tabular}
  \caption{Траектории для стабилизации обратного маятника (\ref{pendulum_system})}
  \label{fig:traj_sep}
\end{figure}

Управления, построенные используя стандартный MPC и при помощи нейросетевого регулятора, показаны на рисунке \ref{fig:u_traj_big}.

\begin{figure}[h!]
\center{\includegraphics[scale=0.7]{u_traj_big}}
\caption{Функция управления для задачи (\ref{pendulum_system})}
\label{fig:u_traj_big}
\end{figure} 

Для вычисления среднего значения времени было проведено $1000$ процедур вычисления первого шага процедуры MPC из различных начальных точек при помощи вышепредставленных методов. При использовании стандартной процедуры MPC среднее значение времени вычисления одного равняется $1633$ мс, в то время как применение нейросетевого регулятора сокращает время выполнения одного шага до $78$ мс.

\section{Выводы}

В данной магистерской диссертации было исследовано применение нейронных сетей для аппроксимации закона управления для нелинейных систем, которые повысили производительность онлайн вычислений в $20$ раз. Также были исследованы разные техники сэмплирования, и было показано, что можно сократить количество точек тренировочного набора на $17 \%$ при использовании стохастического сэмплирования и повышения плотности точек у начала координат. Были построены области притяжения с помощью SVM для более качественного сэмплирования.