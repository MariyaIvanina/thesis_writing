\chapter{ОСНОВНЫЕ ПОНЯТИЯ И ОБЗОР ЛИТЕРАТУРЫ }\label{chap1}

Управление по прогнозирующей модели --- Model Predictive Control (MPC) \cite{Mayne, Grune} --- современный подход к управлению линейными и нелинейными динамическими системами, основанный на решении в реальном времени последовательности задач оптимального управления (ОУ) с конечным временным горизонтом. Упомянутые задачи ОУ называются прогнозирующими, формулируются в зависимости от целей управления, учитывают текущие измерения состояний объекта управления и ограничения на траектории и управляющие воздействия, а также аппроксимируют исходную задачу управления на бесконечном полуинтервале времени.

В настоящей главе излагаются основные принципы и базовый алгоритм MPC на примере задачи стабилизации управляемых движений динамической системы.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Оcновные принципы MPC}\label{1sec:MPC-principles}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

MPC базируется на следующих основных принципах \cite{Mayne}:
\begin{itemize}
\item для предсказания и оптимизации будущего поведения системы используется математическая модель управляемого процесса в пространстве состояний (в отличие от описания в виде передаточной функции и других методов частотной области);
\item для выбранной математической модели формулируется прогнозирующая задача ОУ (predictive optimal control problem), которая будет решаться в каждый момент времени; в этой задаче:
    \begin{itemize}  
    \item конечный промежуток управления;
    \item начальное состояние математической модели совпадает с измеренным текущим состоянием физического объекта управления;
    \item критерий качества отражает цели управления: если целью является стабилизация объекта управления, то критерием качества выступает отклонение траектории объекта от положения равновесия;
    \item учтены ограничения на траекторию и управляющие воздействия;
    \end{itemize}
    
\item оптимальное управление прогнозирующей задачи ОУ (предсказанное управляющее воздействие) применяется к объекту в текущий момент времени и до тех пор пока не будет измерено следующее состояние объекта; затем оптимизация повторяется.
\end{itemize}

Поскольку в каждой момент времени в задаче ОУ учитывается текущее состояние, результирующее управление представляет собой обратную связь.

Популярность MPC в теоретических исследованиях \cite{Mayne, Grune} и на практике \cite{QuinBadgwell} обусловлена следующими свойствами, которыми не обладают другие методы теории управления:
\begin{itemize}
\item  критерий качества в прогнозирующей задаче ОУ позволяет учитывать экономические требования к процессу управления;
\item учитываются жесткие ограничения на фазовые и управляющие переменные;
\item метод применим к нелинейным и многосвязным системам.
\end{itemize}

Отметим, что поскольку решение задачи ОУ повторяется для каждого текущего момент времени, промежуток, для которого прогнозируется поведение системы, постоянно смещается ("скользит"), в силу чего MPC также иногда называется управлением со скользящим горизонтом --- Receding Horizon Control (RHC). 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{МРС для решения задач стабилизации}\label{1sec:stabilization}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Основными и исторически первыми приложениями MPC являются задачи стабилизации и регулирования. Остановимся подробно на результатах, полученных в теории MPC для задачи стабилизации.
В этом разделе также вводятся основные обозначения, понятия, определения, базовые алгоритмы MPC, его свойства.

Как было отмечено выше, основная идея MPC состоит в том, чтобы использовать математическую модель процесса в пространстве состояний для предсказания и оптимизации поведения динамической системы в будущем \cite{Mayne}. Далее считаем, что используемая для предсказаний модель точно описывает процесс управления: на объект не действует возмущения и нет неучтенных различий между моделью и физическим объектом. Такие схемы MPC носят название номинальных (nominal MPC scheme).

Система, которая исследуется в данном разделе, является нелинейной, дискретной, стационарной:
\begin{equation}\label{sys3}
    x(t+1) = f(x(t),u(t)), \ x(0) = x_0.
    \end{equation}
Здесь $x(t) \in X \subseteq \R^n$ --- состояние системы в момент времени $t$, $u(t)\in U \subseteq \R^r$ --- управляющее воздействие в момент $t$, $t \in \mathbb{I}_{\geq 0}$ --- время, дискретное.
Относительно функции $f:\mathbb{R}^n\times\mathbb{R}^r \to \mathbb{R}^n$ предполагается, что она непрерывна.

\begin{remark} В литературе часто встречается следующая запись для системы \ref{sys3}:
\begin{equation}
x^+=f(x,u),
\end{equation}
где $x^+$ означает "следующее"{} состояние.
\end{remark}

Начальное состояние системы (\ref{sys3}) задано:
\begin{equation*}
x(0)= x_0 \in X.
\end{equation*}

На состояния $х$ и управляющие воздействия $u$ накладываются ограничения вида
\begin{equation}\label{1constraints}
    (x(t),u(t))\in Z \subseteq X \times U, \  t \in \mathbb{I}_{\geq 0},
\end{equation}
которые называются смешанными ограничениями. Понятно, что такая форма задания ограничений включают в себя одновременно и фазовые ограничения на состояния системы, и прямые ограничения на управляющие воздействия. Относительно множества $Z$ предполагается, что оно компактно.

Цель (стабилизирующего) MPC --- построить обратную связь $\mu(x)$, при которой замкнутая система \begin{equation}\label{sys4}
    x(t+1) = g(x(t)) = f(x(t), \mu(x(t))), \ x(0) =x_0,
    \end{equation}
будет устойчива в некотором заданном положении равновесия (заданном множестве),  при этом переходный процесс не нарушает ограничения (\ref{1constraints}) при всех $t \in \mathbb{I}_{\geq 0}$.

Дадим определения.

\bigskip
ВОЗМОЖНО ЛУЧШЕ СРАЗУ ДАТЬ ОПРЕДЕЛЕНИЯ НЕ ДЛЯ МНОЖЕСТВА, А ДЛЯ ТОЧКИ

ПОПРАВИТЬ ОФОРМЛЕНИЕ ОПРЕДЕЛЕНИЙ, КАК 1.1
\bigskip



\begin{definition} Множество $X\subseteq\R^n$ называется положительно инвариантным множеством для системы (\ref{sys4}), если  выполняется $g(x)\in X$ \  $\forall x \in X$.
\end{definition}

Определение 1.2 Пусть $X \in \mathbb{R}^n$ --- положительно инвариантное множество для системы \ref{sys4}. Замкнутое, положительно инвариантное множество
$A \subseteq X$ устойчиво для \ref{sys4}, если $\forall \epsilon >0$, $\exists \delta > 0$, что для всех $|x_0 |_A \leq \delta,x_0 \in X$,
выполняется $|x(t)|_A \leq \epsilon$, $\forall t \in \mathbb{I}_{\geq 0}$.
Здесь $|x|_A= inf|x-a|$ --- расстояние от точки x до множества A, $|.|$- евклидова норма.
При $A = {x^* }$ --- точка, получим устойчивость решения $x^*$ по Ляпунову.

Определение 1.3 Множество $A \subseteq X$, удовлетворяющее условиям определения \ref{sys4},  асимптотически устойчиво с областью притяжения X,
если оно устойчиво и $\lim_{t \to \inf} |x(t)|_A = 0$  $\forall x_0 \in X$.

Определение 1.4 Множество А --- глобально асимптотически устойчиво, если оно асимптотически устойчиво с $X =\mathbb{R}^n$.
При $A = \{x^*\}$ имеем асимптотическую устойчивость решения $x(t) =x^*$ по Ляпунову.

Далее для простоты рассмотрим только случай стабилизации системы управления \ref{sys3} для заданного положения равновесия, т.е. случай $A = \{x^*\}\in X$. Естественно, считается, что существует значение $\exists u^*\in U$  такое что
$$
    x^* = f(x^*,u^* ), \ \ (x^*,u^* ) \in Z.
    $$

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Базовый алгоритм MPC}\label{1sec:algo-MPC}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Как было отмечено в разделе~\ref{1sec:MPC-principles}, идея алгоритма MPC состоит в том, чтобы в каждый момент $t \in \mathbb{I}_{\geq 0}$ оптимизировать будущее поведение системы (\ref{sys3}) на конечном горизонте $N \geq 2$ и использовать первое значение полученного оптимального (программного) управления в качестве значения обратной связи для момента $t$. Под "оптимизацией будущего поведения"{} понимается решение прогнозирующей задачи ОУ.

\begin{figure}[h]
\center{\includegraphics[scale=0.3]{mpcscheme}}
\caption{Схема MPC.}
\label{fig:mpc_scheme}
\end{figure}

Понятно, что далее необходимо различать состояния объекта управления $x(t)$, $t \in \mathbb{I}_{\geq 0}$, которые измеряются в каждом конкретном процессе управления, и состояния математической модели, которая используется для предсказаний.

Поэтому состояния математической модели будем будем обозначать $x(k|t)$, $k = 0,1,...N-1 = \mathbb{I}_{[0,N-1]}$. Они изменяются согласно уравнению
\begin{equation}\label{sys5}
    x(k+1|t) = f(x(k|t),u(k|t)), \ x(0|t) = x(t), \ k \in I_{[0,N-1]}.
\end{equation}
Здесь аргумент $t$ после черты подчеркивает зависимость от текущего момента, для которого  проводится оптимизация. Начальное состояние --- текущее состояние объекта управления $x(t)$.

\bigskip
НЕ НРАВЯТСЯ ОБОЗНАЧЕНИЯ НИЖЕ, СМ. ОБОЗНАЧЕНИЯ ДЛЯ ОПТИМАЛЬНОГО УПРАВЛЕНИЯ. НУЖНЫ ЛИ ОНИ ТУТ ВООБЩЕ? ИЛИ ОНИ НУЖНЫ ВЫШЕ, ПОТОМУ ЧТО $u(k|t)$ ФИГУРИРУЕТ В (\ref{sys5})?
\bigskip

Далее используются обозначения:

$u(t) =\{u(0|t),u(1|t),...,u(N-1)\}$ --- предсказываемое управляющее воздействие;

$x(t) = \{x(0|t),...,x(N|t)\}$ --- соответствующая траектория системы (\ref{sys5});

$N$ --- горизонт планирования.

Обсудим ограничения прогнозирующей задачи ОУ. Понятно, что она должна включать ограничения (\ref{1constraints}), записанные для состояний математической модели (\ref{sys5}):
$$
    (x(k|t),u(k|t)) \in Z \ \ \forall k \in \mathbb{I}_{[0,N-1]}.
    $$
Кроме приведенных смешанных ограничений,  в задачу, как правило, добавляются ограничения в терминальный момент времени: $x(N|t)\in X_f$, где $X_f\subset \R^n$ --- терминальное множество.  "Терминальные ингредиенты"{} прогнозирующей задачи более подробно будет рассмотрены ниже, после ее формализации.

Оставшийся элемент прогнозирующей задачи ОУ --- критерий качества. В задачах стабилизации критерий качества выбирается исследователем, практиком, и является, скорее, параметром настройки схемы MPC. Например, в задаче стабилизации (см. \cite{Mayne}) критерий качества выбирается из соображений штрафа любого состояния $x \in X$, отклоняющегося от состояния равновесия $x^*$. Также часто штрафуются отклонения управления $u \in U$ от значения $u^*$. Как отмечается в \cite{Mayne}, последнее условие полезно с вычислительной точки зрения, поскольку для численных методов зачастую проще решить задачу, в которой в критерии качества штрафуются управляющие воздействия. С другой стороны \cite{Mayne}, с точки зрения реализации управления также желательно избежать значений $u \in U$, соответствующих чрезмерным энергетическим затратам.

Критерий качества будет состоять из терминальной стоимости $V_f (x(N|t))$ и суммарной стоимости переходного процесса, т.е. это будет критерий качества типа Больца. Терминальная стоимость будет рассмотрена ниже, при обсуждении терминальных ингредиентов задачи ОУ. Стоимость переходного процесса для дискретных систем задается суммой стоимостей за каждый этап (для каждого $k\in \mathbb{I}_{[0,N-1]}$):
$$
    \sum_{k =0}^{N-1}l(x(k|t),u(k|t).
    $$
В литературе функция $l:\R^n \times \R^r \to \R$ называется стоимостью этапа (stage cost).

\bigskip
ЗДЕСЬ НУЖНО ПРОВЕРИТЬ ПУНКТ 2 ПРЕДПОЛОЖЕНИЙ И ПРИВЕСТИ В СООТВЕТСТВИЕ НАПРИМЕР С КОНСПЕКТОМ
\bigskip

Относительно $l$ предполагается, что она непрерывна, а также:
\begin{enumerate}
\item  $l(x^*,u^*) = 0$, т.е. стоимость обращается в нуль в точке равновесия;
\item  имеет 2 разных вида
согласно [1], $l(x,u) > 0$ для $\forall(x,u) \in Z,x \neq x^*$
согласно [2], $\exists$ функция $\alpha_1$ класса $K_\infty$, что выполняется
$l(x,u) \geq \alpha1(|x-x^*|)$ $\forall (x,u) \in Z$.
\end{enumerate}

Ниже, в разделе~\ref{1sec:stability_system}, будут обсуждаться попyлярные решения при выборе $l$.

\bigskip
А ЕСТЬ ЛИ ОБСУЖДЕНИЕ?
\bigskip

Таким образом, прогнозирующая задача ОУ для момента времени $t$ имеет вид:
\begin{equation}\label{1OCP}
{\cal P}(t):\qquad	\min_{u(t)} \ \sum_{k = 0}^{N-1}l(x(k|t),u(k|t)) + V_f (x(N|t)),
\end{equation}
при условиях
$$
    x(k+1|t) = f(x(k|t),u(k|t)) \ \ \forall\ k \in \mathbb{I}_{[0,N-1]},
    $$ 
$$  
    x(0|t)= x(t),
    $$
$$
    (x(k|t),u(k|t)) \in Z, \ \ \forall\ k \in \mathbb{I}_{[0,N-1]},
    $$
$$
    x(N|t) \in X_f.
    $$
    
\bigskip
НУЖНО ЛИ ЭТО ОБОЗНАЧЕНИЕ?
\bigskip

Часто критерий качества обозначают через
$J_N(x(t),u(t))= \sum_{k = 0}^{N-1}l(x(k|t),u(k|t)) + V_f (x(N|t)).$

В задаче (\ref{1OCP}) обсуждавшиеся выше "терминальные ингредиенты"{}:
\begin{itemize}
\item терминальная стоимость $V_f (x(N|t))$ в критерии качества;
\item терминальное ограничение $x(N|t)\in X_f$, где $X_f$ --- терминальное множество (terminal region).
\end{itemize}

Именно условия на эти элементы обеспечивают устойчивость замкнутой системы несмотря на то, что решается задача с конечным горизонтом (см. раздел~\ref{1sec:stability_system}).

Далее используем следующие обозначения: 
\\
$u^0 (\cdot|t) = \{u^0 (0|t),\ldots,u^0 (N-1|t)\}$ --- оптимальное (программное) управление  задачи ${\cal P}(t)$; \\
$x^0 (\cdot|t) = \{x^0 (0|t),\ldots,x^0 (N|t)\}$ --- соответствующая траектория;\\

\bigskip
В СЛЕДУЮЩЕЙ СТРОКЕ КАКАЯ-ТО ПУТАНИЦА В ОБОЗНАЧЕНИЯХ?
\bigskip

$V_f (x(t)) = J_N (x(t),u^0(t))$ --- оптимальное значение критерия качества (value function, функция Беллмана); \\
$X_N$ --- множество всех состояний $x \in X$, для которых существует решение задачи (\ref{1OCP}) с $x(t) = x$.

\begin{remark}
    Если ${\cal P}(t)$ имеет не единственное решение, то выбирается какое-то одно, из прочих соображений (например, используется другой критерий качества). Считаем далее, что
    $u^0 (\cdot|t)$ --- единственное оптимальное управление.
\end{remark}

\textbf{Базовый алгоритм MPC} состоит в следующем: \\
Для каждого $t \in \mathbb{I}_{\geq 0}$
\begin{enumerate}
\item измерить состояние $x(t) \in X$ системы (\ref{sys3});
\item решить задачу (\ref{1OCP}) с начальным условием $x(0|t) = x(t)$, получить ее решение $u^0 (\cdot|t)$;
\item подать на вход системы (\ref{sys3}) управляющее воздействие
\begin{equation}\label{1MPC-input}
    u_{MPC}(t):=u^0(0|t).	
\end{equation}
\end{enumerate}

Таким образом, в каждый момент $t \in \mathbb{I}_{\geq 0}$ на систему подается управляющее воздействие (\ref{1MPC-input}), которое неявно зависит от текущего состояния $x(t)$.
Соответственно, замкнутая система имеет вид
\begin{equation}\label{1MPC-closed}
    x(t+1) = f(x(t), u^0 (0|t)),t \in \mathbb{I}_{\geq 0}.
\end{equation}

После 20 лет исследований  теория MPC приобрела свои нынешние черты. Согласно \cite{FernandoFontes} все схемы номинального MPC описываются представленным базовым алгоритмом, а все прогнозирующие задачи ОУ в общем виде формулируются как (\ref{1OCP}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Терминальные ингредиенты и устойчивость замкнyтой системы}\label{1sec:stability_system}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%(см., например, стр. 46 \cite{Mayne}).

Cхемы MPC зависят от выбора терминальных элементов $V_f$ и $X_f$.  Например, самые первые результаты исследований по MPC \cite{} были получены для состояния равновесия, совпадающего с началом координат $(x^*,u^*) = (0,0)$ (т.е. $f(0,0) = 0$) и предлагали использовать
$X_f= {0}$, т.е. терминальное условие принимало вид $x(N|t) = 0$. Сразу отметим, что ограничения-равенства считаются "плохими"{} с точки зрения вычислительных алгоритмов, поэтому дальнейшее развитие теории продолжалось в направлении ослабления этих простейших условий.

В частности, в работе \cite{FernandoFontes} приведены следующие общие условия, которым должны удовлетворять терминальное множество $X_f$ и терминальная стоимость $V_f$.  Эти условия , дополняют условия 1--2 на функцию стоимость этапа $l$ и имеют вид:
\begin{enumerate}
\item[3.] $V_f$ непрерывна;
\item[4.] терминальное множество $X_f$ замкнуто, $\{x^*\} \in \int X_f$;
\item[5.] существует локальная обратная связь $k_f: X_f \to U$, такая что для $\forall x \in X_f$ имеет место
\begin{enumerate}
\item[а)] $(x,k_f (x)) \in Z$;
\item[б)] $f(x,k_f (x)) \in X_f$;
\item[в)] $V_f(f(x,k_f (x))) - V_f (x) \leq -l(x,k_f (x)) + l(x^*,u^*).$
\end{enumerate}
\end{enumerate}

В 5) условие а) гарантирует допустимость локальной обратной связи  $k_f (x)$, $x \in X_f$. Условие б) означает, что терминальное множество $X_f$ является положительно инвариантным для системы, замкнутой локальной обратной связью: $x(t+1) = f(x(t),k_f (x(t))) = g(x(t))$. Условие в) вместе с условиями на $l$ означает, что терминальная стоимость $V_f$ может служить функцией Ляпунова на терминальном множестве $X_f$.


В работах \cite{Grune, Mayne} для дискретных систем можно найти следующий основной результат:

\begin{theorem}\label{theory1} Пусть $x_0 \in X_N$ и выполнены все предположения 1 --- 5 относительно функций $l,V_f$  и терминального множества $X_f$.
Тогда
\begin{enumerate}
\item замкнутая система \ref{1MPC-closed}, полученная в результате применения базового алгоритма, удовлетворяет ограничениям \ref{sys3} для всех $t \in \mathbb{I}_{\geq 0}$;

\item задача (\ref{1OCP}) имеет решение для всех $t \in \mathbb{I}_{\geq 0}$;

\item $x^*$ --- асимптотически устойчивое положение равновесия с областью притяжения  $X_N$.
\end{enumerate}
\end{theorem}

\bigskip
ПРАВИЛЬНО ЛИ Я ПОНЯЛА, ЧТО ПОЖУРИЛИ ЗА ВКЛЮЧЕНИЕ ДОКАЗАТЕЛЬСТВА? ЕСЛИ ДА, ТО УБРАТЬ. ВМЕСТО ЭТОГО ПРИВЕСТИ СООБРАЖЕНИЯ ПО ВЫБОРУ $V_f$, $X_f$, И ДАЛЕЕ НУЖЕН ОБЗОР ЛИТЕРАТУРЫ ПО ТЕМЕ РАБОТЫ -- ТЕ СТАТЬИ, ЧТО ВЫ ЧИТАЛА ПО РЕКОМЕНДАЦИИ ЙОХАНЕСА. ВЕСТЬ ТЕКСТ НИЖЕ, ПОЖАЛУЙ, НЕ НУЖЕН.
\bigskip


\proof
 Доказательство взято из источника \cite{Mayne}.Стандартный подход для  доказательства устойчивости - использовать функцию Ляпунова как функцию для вычисления оптимального значения задачи оптимального управления
 на бесконечном горизонте. Это соответствует использованию $V^0_N(\cdot)$ для задачи оптимального управления на конечном горизонте.
 Функция $V_{\infty}(\cdot)$ удовлетворяет равенству $V^0_{\infty}(f(x,k_{\infty}(x)))=V^0_{\infty}(x) - l(x,k_{\infty}(x))$, тем самым удовлетворяя предположение 5.
 Оптимальность системы не всегда обеспечивает устойчивость этой системы, когда горизонт конечный, поэтому от правильного выбора терминальных ингредиентов будет зависеть
 устойчивость системы. Если мы докажем для функции на конечном горизонте верно, что $V^0_N(f(x,k_N(x))) \leq V^0_N(x) - l(x,k_N(x))$ для $\forall x \in X_N$,то это будет
 гарантировать асимптотическую устойчивость.

 Пусть у нас не будут ограничения на состояние, т.е. $X=X_f=X_N=\mathbb{R}^n$ и x - любое состояние $\in X_N$ в момент времени 0. Тогда
 \begin{equation*}
 V_N^0(x) = V_N(x, u^0(x))
 \end{equation*}
 в которой $u^0(\cdot|x) = \{ u^0(0|x), u^0(1|x), ..., u^0(N-1|x) \}$ - минимизирующая управляющая последовательность, и соотвествующая ей оптимальная последовательность
 состояний $x^0(\cdot|x) = \{ x^0(0|x), x^0(1|x), ..., x^0(N|x) \}$, где $x^0(0|x) = x, x^0(1|x) = x^+$. Следующее состояние по отнощение к $x$ в момент времени 0 - это
 $x^+ = f(x,k_N(x)) = x^0(1|x)$ в момент времени 1, где $K_N(x) = u^0(0|x)$ и
 \begin{equation*}
 V_N^0(x^+) = V_N(x^+, u^0(x^+))
 \end{equation*}
 в которой $u^0(\cdot|x^+) = \{ u^0(0|x^+), u^0(1|x^+), ..., u^0(N-1|x^+) \}$. Сложно сравнивать $V^0_N(x)$ и $V^0_N(x^+)$ непосредственно, но
 \begin{equation*}
 V^0_N(x^+) = V_N(x^+, u^0(x^+)) \leq V_N(x^+, \bar u)
 \end{equation*}
 где $\bar u$ некоторая допустимая управляющая последовательность. Для облегчения сравнения, мы выберем $\bar u = \{u^0(1|x), ..., u^0(N-1|x), u \}$
 и соотвествующая ей последовательность состояний $\bar x = \{x^0(1|x), ..., x^0(N|x), f(x^0(N|x),u)\}$. Так как $u$ и $\bar u$ совпадают для $i = 1,..,N-1$, но не для
 $i = N$. То запишем в таком виде
 \begin{equation*}
 V_N^0(x)=V_N(x,u^0(x)) = l(x, k_N(x)) + \sum_{j=1}^{N-1}l(x^0(j|x), u^0(j|x)) + V_f(x^0(N|x))
 \end{equation*}
 а значит мы можем выразить $V_N(x^+, \bar u)$:
 \begin{equation*}
   V_N(x^+, \bar u) = V_N^0(x) - l(x, k_N(x)) - V_f(x^0(N|x)) + l(x^0(N|x),u)+V_f(f(x^0(N|x),u))
 \end{equation*}
 А так как $V^0_N(x^+) \leq V_N(x^+, \bar u)$, то подставим сюда полученные выше равенства и получим, что
 \begin{equation*}
  V_N^0(f(x, k_N(x))) - V_N^0(x) \leq - l(x, k_N(x))
 \end{equation*}
 если верно следующее
  \begin{equation*}
V_f(f(x,u)) - V_f(x) + l(x,u) \leq 0
\end{equation*}
 Что и требовалось доказать.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Терминальное множество и терминальная функция}\label{1sec:terminal_ingredients}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В задаче (\ref{sys6}) терминальные "ингредиенты":
\begin{itemize}
\item функция терминального состояния $V_f (x(N|t))$ в критерии качества;
\item терминальное ограничение $x(N|t)\in X_f$, где $X_f$ --- терминальное множество.
\end{itemize}

Именно условия на эти элементы обеспечивают устойчивость замкнутой системы несмотря на то, что решается задача с конечным горизонтом.
Существует несколько подходов для нахождения этих терминальных "ингредиентов". В рамках диссертации нас будут интересовать следующие два подхода:
\begin{itemize}
\item MPC на квази-бесконечном горизонте
\item Обобщенный фреймворк для MPC
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{MPC на квази-бесконечном горизонте}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

MPC на квази-бесконечном горизонте оптимизирует on-line функционал, состоящий
из стоимости на конечном горизонте и терминальной стоимости, при условиях динамичности системы,
входных ограничений и дополнительному ограничению на терминальное состояние. Выполнимость неравества для терминального
ограничения подразумевает под собой, что состояния в конце конечного горизонта в предписанном терминальном множестве. Терминальные состояния
штрафуются таким образом, что терминальная стоимость ограничивает стоимость на бесконечном горизонте для нелинейной системы, управляемой фиктивной
локальной линейной обратной связью. Если первое приближение системы стабилизируемо, то существует единственное решение уравнения Ляпунова, и тогда можно определить
терминальную функцию и множество off-line.

Рассмотрим первое приближение системы в начале координат
\begin{equation*}
    \dot x = f(x,u,t), x(t_0) = x_0
\end{equation*}
и получим линейную систему
\begin{equation*}\dot x = Ax + Bu \end{equation*}
где
$A =(\frac{\partial f}{\partial x})(0,0)$ и
$B =(\frac{\partial f}{\partial u})(0,0)$
Если уравнение можно стабилизировать, то линейная обратная связь для состояния
\begin{align*}
u &= Kx \\
A_K &= A+BK
\end{align*} асимптотически устойчива.


\begin{lemma}\label{lemma1}
Предположим, что первое приближение системы в начале координат стабилизируемое, тогда
\begin{enumerate}
\item уравнение Ляпунова
\begin{equation}\label{quasi_lyapunov}
(A_K+kI)^TP + P(A_K+kI) = - Q^*
\end{equation}
допускает единственную положительно определенную и симметричную матрицу P, где
 $Q^*=Q+K^TRK$ - положительно определенная и симметричная; $k \in [0, \infty)$ удовлетворяет $k < - \lambda_{max}(A_K)$.
\item $\exists \alpha \in (0, \infty)$ определяющая окрестность $\Omega_{\alpha}$ начала координат в форме  $\Omega_{\alpha} = \{x \in \mathbb{R}^n | x^TPx \leq \alpha\}$ такая что
 \begin{enumerate}
 \item $Kx \in U$, для $\forall x \in \Omega_{\alpha}$, т.е. линейный контроллер с обратной связью не нарушает входных ограничений в $\Omega_{\alpha}$
 \item $\Omega_{\alpha}$ инвариантно для нелинейных систем, контролируемых локальной линейной обратной связью $u=Kx$
 \item  для любого $x_1 \in \Omega_{\alpha}$, критерий качества для бесконечного горизонта $J^{\infty}(x_1, u)= \int_{t_1}^{\infty}(\|x(t)\|_Q^2+\|u(t)\|_R^2)dt$ ограничен таким образом:
 \begin{equation*}
 J^{\infty}(x_1, u) \leq x_1^TPx_1.
 \end{equation*}
 \end{enumerate}

\end{enumerate}
\end{lemma}
\proof
Доказательство взято из источника \cite{ChenAlgower}.
\begin{enumerate}

\item Так как $Q^* >0$, для разрешимости уравнения Ляпунова необходимо,чтобы действительные части  всех собственных значений
$A_k+kI$ были отрицательными, если это выполняется, то уравнение Ляпунова \ref{quasi_lyapunov}
разрешимо и решение единственно, положительно определенное и симметричное.Так как $A_k$ - асимптотически устойчива, то любая константа $k \in [0, -\lambda_{max}(A_K)]$
гарантирует отрицательность действительной части собственных значений $(A_K + kI)$
\item
\begin{enumerate}
\item Так как $P > 0$ и $0 \in \mathbb{R}^m$ в int$U$, тогда можно найти $\alpha_1 \in (0, \infty)$, такое, что $Kx \in U$ для $\forall x \in \Omega_{\alpha_1}$, а значит
линейная управляющая обратная связь удовлетворяет входным ограничениям на $\Omega_{\alpha_1}$. Допустим $\alpha \in (0, \alpha_1]$ определяет область в форме $\Omega_{\alpha} = \{x \in \mathbb{R}^n | x^TPx \leq \alpha\}$, тогда это множество тоже будет удовлетворять
входным ограничениям, так как $\alpha \leq \alpha_1$.
\item Продифференцируем $x^TPx$ вдоль траектории $\dot x = f(x, Kx)$ и получим
\begin{equation}\label{different_xpx}
 \frac{d}{dt}x(t)^Tpx(t) = x(t)^T(A_k^TP + PA_k)x(t) + 2x(t)^TP\phi(x(t))
\end{equation}
где $\phi(x)=f(x, Kx) - A_kx$. Так как последнее слагаемое ограничено таким образом
\begin{equation*}
x^TP\phi(x) \leq \parallel x^T \parallel \cdot \parallel \phi(x) \parallel \leq \parallel P \parallel \cdot L_{\phi} \cdot \parallel x\parallel^2
			\leq \frac{\parallel P \parallel L_{\phi}}{\lambda_{min}(P)} \parallel x \parallel^2_P
\end{equation*}
где $L_{\phi}=sup \{ \parallel \phi(x) \parallel  / \parallel x \parallel| x \in \Omega_{\alpha}, x \neq 0 \}$. Теперь мы выбираем $\alpha \in (0, \alpha_1]$,
такой что в $\Omega_{\alpha}$
\begin{equation*}
L_{\phi} \leq \frac{k \lambda_{min}(P)}{\parallel P \parallel}
\end{equation*}
Тогда неравенство ведет к
\begin{equation*}
X^TP\phi(x) \leq kx^TPx
\end{equation*}
Подставим полученное неравенство в (\ref{different_xpx})  и получим следующее
\begin{equation*}
   \frac{d}{dt}x(t)^TPx(t) \leq x(t)^T((A_k+kI)^TP + P(A_k+kI))x(t)
\end{equation*}
в свою очередь это ведет к $\frac{d}{dt}x(t)^TPx(t) \leq -x(t)^TQ^*x(t)$. Так как $P > 0$ и $Q^* > 0$, то это неравенство предполагает, что область $\Omega_{\alpha}$ инвариантна
для системы, и любая траектория начинающаяся из этой области сходится к началу координат.
\item Если проинтегрируем $\frac{d}{dt}x(t)^TPx(t) \leq -x(t)^TQ^*x(t)$ от $t_1$ до $\infty$ с начальным условием $x(t_1)=x_1$, то получим необходимый результат $ J^{\infty}(x_1, u) \leq x_1^TPx$.
\end{enumerate}
\end{enumerate}

Алгоритм нахождения терминальной функции и терминального множества
\begin{enumerate}
\item Найти линейную обратную связь $Kx$.
\item Выбрать константу $k \in [0, \infty)$, удовлетворяющую неравенству $k < - \lambda_{max}(A_K)$ и решить уравнение Ляпунова для нахождения $P$.
\item Найти наибольшую из возможных $\alpha_1$, такую что $Kx \in U$, для $\forall x \in \Omega_{\alpha_1}$.
\item Найти наибольшую из возможных $\alpha \in (0, \alpha_1)$, такую что неравенство
\begin{equation*}
	sup \left( \frac{\|f(x,Kx) - A_Kx\|}{\|x\|}| x \in \Omega_{\alpha} , x \neq 0 \right) \leq \frac{k\lambda_{min}(P)}{\|P\|}
\end{equation*}
удовлетворяется для $\Omega_{\alpha}$.
\end{enumerate}

\begin{theorem}
Допустим
\begin{enumerate}
\item $f: \mathbb{R}^n \times \mathbb{R}^m -> \mathbb{R}^n$ дважды дифференцируема, $f(0,0) = 0$ => 0 - точка равновесия системы с $u=0$
\item $U \subset \mathbb{R}^m$ компактно, выпукло и $0 \in intU$
\item $\exists$ решение задачи для любого начального $x_0 \in \mathbb{R}^n$, задача имеет кусочно непрервную $u(\cdot): [0,\infty) -> U$
\end{enumerate}
Если 1-3 предположения выполняются и
\begin{itemize}
\item первое приближение системы стабилизируемо
\item программируемое управление разрешимо в $t=0$
\end{itemize}
То замкнутая система асимптотически устойчива.
\end{theorem}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Обобщенный фреймворк для MPC}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Данный фреймворк был придуман для расширения класса систем, для которых применим MPC. Системы должны удовлятворять достаточно нестрогим условиям и терминальные игредиенты
будут выбираться таким образом, чтобы удовлетворить некоторые условия устойчивости, и таким образом замкнутая система будет иметь гарантированную асимптотическую устойчивость.
В MPC на квази-бесконечном горизонте мы работали с теми системами, для которых первое приближение стабилизируемо, в данном же фреймворке такие требования не предъявляются и
класс систем расширяется и включает в себя неголономные системы тоже.

Нелинейная система
\begin{equation*}
    \dot x = f(x,u,t), x(t_0) = x_0
    \end{equation*}
Гипотезы, которые предполагаем для систем, которыми будем управлять:
\begin{enumerate}
\item $U(t)$ содержит начальную точку и $f(t,0,0)=0$
\item Функция $f$ непрерывная и $x \mapsto f(t,x,u)$ локально непрерывна по Липшицу для $\forall (t,u)$
\item $U(t)$ компактно и для любой пары $(t,x) f(t,x,U(t))$ выпукло
\item Функция $f$ компактна на компакте множеств $x$, т.е. $\{\parallel f(t,x,u) \parallel :t \in \mathbb{R}, x \in X, u \in U(t)\}$ компактно
\end{enumerate}
Как видно из гипотез, в отличие от MPC на квази-бесконечном горизонте, мы не требуем от системы, чтобы существовало ее решение, поэтому данные условия достаточно не строгие,
но они вместе с новыми условиями устойчивости будут гарантировать асимптотическую устойчивостьт системы.
Условия устойчивости:
\begin{enumerate}
\item Множество $X_f$ замкнуто и содержит начало координат
\item $l$ непрерывна, $l(\cdot,0,0) = 0$ и радиально неограниченная функция $\exists M:\mathbb{R}^n -> \mathbb{R}_+$,
такая что $l(t,x,u) \geq M(x) \forall (t,u) \in \mathbb{R} \times \mathbb{R}^m$.
Более того расширенное множество скорости $\{ (v,l) \in \mathbb{R}^n \times \mathbb{R}_+ : v = f(t,x,u), l \geq l(t,x,u), u \in U(t) \}$ выпукло для любых $(t,x)$
\item $V_f$ положительно полуопределенная и непрерывно дифференцируема
\item Горизонт планирования $T$ такой что, множество $X_f$ достижимо для любого начального состояния и что существует $\forall (t_0,x_0) \in \mathbb{R} \times X, \exists u: [t_0, t_0+T] \to \mathbb{R}^m$
удовлетворяющее $x(t_0+T; t_0, x_0,u) \in X_f$ и $x(t; t_0, x_0,u) \in X, \forall t \in [t_0, t_0 + T]$
\item Тогда существует $\exists \epsilon > 0, \forall t \in [T;\infty), x_t \in X_f$ мы можем выбрать управляющее воздействие
$\bar u:[t, t+ \epsilon] -> \mathbb{R}^m, \bar u(s) \in U(s)$ удовлетворяющее
\begin{equation*}
\forall s \in [t, t + \epsilon], \frac{dV_f(t, x_t)}{dt} + \frac{dV_f(t, x_t)}{dx}f(t,x_t,\bar u(t)) \leq -l(t, x_t, \bar u(t))
\end{equation*}  и
$x(t+r;t,x_t, \bar u) \in X_f \forall r \in [0, \epsilon]$
\end{enumerate}

\begin{theorem}
Предположим гипотезы 1-4. Выберем параметры для системы,удовлетворяющей условиям 1-5. Тогда замкнутая система будет асимптотически устойчивой, $\parallel x^*(t) \parallel -> 0 $ при $t -> \infty$
\end{theorem}


\bigskip
