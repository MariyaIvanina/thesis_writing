\chapter{ОСНОВНЫЕ ПОНЯТИЯ И ОБЗОР ЛИТЕРАТУРЫ }\label{chap1}

Управление по прогнозирующей модели --- Model Predictive Control (MPC) \cite{Mayne, Grune} --- современный подход к управлению линейными и нелинейными динамическими системами, основанный на решении в реальном времени последовательности задач оптимального управления (ОУ) с конечным временным горизонтом. Упомянутые задачи ОУ называются прогнозирующими, формулируются в зависимости от целей управления, учитывают текущие измерения состояний объекта управления и ограничения на траектории и управляющие воздействия, а также аппроксимируют исходную задачу управления на бесконечном полуинтервале времени.

В настоящей главе излагаются основные принципы и базовый алгоритм MPC на примере задачи стабилизации управляемых движений динамической системы.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Оcновные принципы MPC}\label{1sec:MPC-principles}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

MPC базируется на следующих основных принципах \cite{Mayne}:
\begin{itemize}
\item для предсказания и оптимизации будущего поведения системы используется математическая модель управляемого процесса в пространстве состояний (в отличие от описания в виде передаточной функции и других методов частотной области);
\item для выбранной математической модели формулируется прогнозирующая задача ОУ (predictive optimal control problem), которая будет решаться в каждый момент времени; в этой задаче:
    \begin{itemize}  
    \item конечный промежуток управления;
    \item начальное состояние математической модели совпадает с измеренным текущим состоянием физического объекта управления;
    \item критерий качества отражает цели управления: если целью является стабилизация объекта управления, то критерием качества выступает отклонение траектории объекта от положения равновесия;
    \item учтены ограничения на траекторию и управляющие воздействия;
    \end{itemize}
    
\item оптимальное управление прогнозирующей задачи ОУ (предсказанное управляющее воздействие) применяется к объекту в текущий момент времени и до тех пор пока не будет измерено следующее состояние объекта; затем оптимизация повторяется.
\end{itemize}

Поскольку в каждой момент времени в задаче ОУ учитывается текущее состояние, результирующее управление представляет собой обратную связь.

Популярность MPC в теоретических исследованиях \cite{Mayne, Grune} и на практике \cite{QuinBadgwell} обусловлена следующими свойствами, которыми не обладают другие методы теории управления:
\begin{itemize}
\item  критерий качества в прогнозирующей задаче ОУ позволяет учитывать экономические требования к процессу управления;
\item учитываются жесткие ограничения на фазовые и управляющие переменные;
\item метод применим к нелинейным и многосвязным системам.
\end{itemize}

Отметим, что поскольку решение задачи ОУ повторяется для каждого текущего момент времени, промежуток, для которого прогнозируется поведение системы, постоянно смещается ("скользит"), в силу чего MPC также иногда называется управлением со скользящим горизонтом --- Receding Horizon Control (RHC). 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{МРС для решения задач стабилизации}\label{1sec:stabilization}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Основными и исторически первыми приложениями MPC являются задачи стабилизации и регулирования. Остановимся подробно на результатах, полученных в теории MPC для задачи стабилизации.
В этом разделе также вводятся основные обозначения, понятия, определения, базовые алгоритмы MPC, его свойства.

Как было отмечено выше, основная идея MPC состоит в том, чтобы использовать математическую модель процесса в пространстве состояний для предсказания и оптимизации поведения динамической системы в будущем \cite{Mayne}. Далее считаем, что используемая для предсказаний модель точно описывает процесс управления: на объект не действует возмущения и нет неучтенных различий между моделью и физическим объектом. Такие схемы MPC носят название номинальных (nominal MPC scheme).

Система, которая исследуется в данном разделе, является нелинейной, дискретной, стационарной:
\begin{equation}\label{sys3}
    x(t+1) = f(x(t),u(t)), \ x(0) = x_0.
    \end{equation}
Здесь $x(t) \in X \subseteq \R^n$ --- состояние системы в момент времени $t$, $u(t)\in U \subseteq \R^r$ --- управляющее воздействие в момент $t$, $t \in \mathbb{I}_{\geq 0}$ --- время, дискретное.
Относительно функции $f:\mathbb{R}^n\times\mathbb{R}^r \to \mathbb{R}^n$ предполагается, что она непрерывна.

Начальное состояние системы (\ref{sys3}) задано:
\begin{equation*}
x(0)= x_0 \in X.
\end{equation*}

На состояния $х$ и управляющие воздействия $u$ накладываются ограничения вида
\begin{equation}\label{1constraints}
    (x(t),u(t))\in Z \subseteq X \times U, \  t \in \mathbb{I}_{\geq 0},
\end{equation}
которые называются смешанными ограничениями. Понятно, что такая форма задания ограничений включают в себя одновременно и фазовые ограничения на состояния системы, и прямые ограничения на управляющие воздействия. Относительно множества $Z$ предполагается, что оно компактно.

Цель (стабилизирующего) MPC --- построить обратную связь $u(x)$, при которой замкнутая система \begin{equation}\label{sys4}
    x(t+1) = g(x(t)) = f(x(t), u(x(t))), \ x(0) =x_0,
    \end{equation}
будет устойчива в некотором заданном положении равновесия (заданном множестве),  при этом переходный процесс не нарушает ограничения (\ref{1constraints}) при всех $t \in \mathbb{I}_{\geq 0}$.

\begin{definition}
Точка $x^*$ является положением равновесия для динамики \ref{sys4}, если выполняется $x^*=f(x^*,u^*)$.
\end{definition}

\begin{definition} Множество $X\subseteq\R^n$ называется положительно инвариантным множеством для системы (\ref{sys4}), если  выполняется $g(x)\in X$ \  $\forall x \in X$.
\end{definition}

\begin{definition} Пусть $X \in \mathbb{R}^n$ --- положительно инвариантное множество для системы \ref{sys4}. Замкнутое, положительно инвариантное множество
$A \subseteq X$ устойчиво для \ref{sys4}, если $\forall \epsilon >0$, $\exists \delta > 0$, что для всех $||x_0 ||_A \leq \delta,x_0 \in X$,
выполняется $||x(t)||_A \leq \epsilon$, $\forall t \in \mathbb{I}_{\geq 0}$.
Здесь $||x||_A= inf|x-a|$ --- расстояние от точки x до множества A.
При $A = {x^* }$, получим устойчивость решения $x^*$ по Ляпунову.
\end{definition}

\begin{definition} Множество $A \subseteq X$, удовлетворяющее условиям определения \ref{sys4},  асимптотически устойчиво с областью притяжения X,
если оно устойчиво и $\lim_{t \to \inf} ||x(t)||_A = 0 \ \forall x_0 \in X$.
\end{definition}

\begin{definition} Множество А --- глобально асимптотически устойчиво, если оно асимптотически устойчиво с $X =\mathbb{R}^n$.
При $A = \{x^*\}$ имеем асимптотическую устойчивость решения $x(t) =x^*$ по Ляпунову.
\end{definition}

Далее будет рассматриваться случай стабилизации системы управления \ref{sys3} для заданного положения равновесия, т.е. случай $A = \{x^*\}\in X$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Базовый алгоритм MPC}\label{1sec:algo-MPC}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Как было отмечено в разделе~\ref{1sec:MPC-principles}, идея алгоритма MPC состоит в том, чтобы в каждый момент $t \in \mathbb{I}_{\geq 0}$ оптимизировать будущее поведение системы (\ref{sys3}) на конечном горизонте $N \geq 2$ и использовать первое значение полученного оптимального (программного) управления в качестве значения обратной связи для момента $t$. Под "оптимизацией будущего поведения" понимается решение прогнозирующей задачи ОУ.

\begin{figure}[h]
\center{\includegraphics[scale=0.3]{mpc_scheme}}
\caption{Схема MPC.}
\label{fig:mpc_scheme}
\end{figure}

Понятно, что далее необходимо различать состояния объекта управления $x(t)$, $t \in \mathbb{I}_{\geq 0}$, которые измеряются в каждом конкретном процессе управления, и состояния математической модели, которая используется для предсказаний.

Поэтому состояния математической модели будем будем обозначать $x(k|t)$, $k = 0,1,...N-1 = \mathbb{I}_{[0,N-1]}$. Они изменяются согласно уравнению
\begin{equation}\label{sys5}
    x(k+1|t) = f(x(k|t),u(k|t)), \ x(0|t) = x(t), \ k \in I_{[0,N-1]}.
\end{equation}
Здесь аргумент $t$ после черты подчеркивает зависимость от текущего момента, для которого  проводится оптимизация. Начальное состояние --- текущее состояние объекта управления $x(t)$.

Ограничения (\ref{1constraints}), записанные для состояний математической модели (\ref{sys5}), имеют вид:
$$
    (x(k|t),u(k|t)) \in Z \ \ \forall k \in \mathbb{I}_{[0,N-1]}.
    $$
Кроме приведенных смешанных ограничений,  в задачу, как правило, добавляются ограничения в терминальный момент времени: $x(N|t)\in X_f$, где $X_f\subset \R^n$ --- терминальное множество.  "Терминальные элементы" прогнозирующей задачи более подробно будут рассмотрены ниже после ее формализации.

Оставшийся элемент прогнозирующей задачи ОУ --- критерий качества. В задачах стабилизации критерий качества выбирается исследователем, практиком, и является, скорее, параметром настройки схемы MPC. Например, в задаче стабилизации (см. \cite{Mayne}) критерий качества выбирается из соображений штрафа любого состояния $x \in X$, отклоняющегося от состояния равновесия $x^*$. Также часто штрафуются отклонения управления $u \in U$ от значения $u^*$. Как отмечается в \cite{Mayne}, последнее условие полезно с вычислительной точки зрения, поскольку для численных методов зачастую проще решить задачу, в которой в критерии качества штрафуются управляющие воздействия. С другой стороны \cite{Mayne}, с точки зрения реализации управления также желательно избежать значений $u \in U$, соответствующих чрезмерным энергетическим затратам.

Критерий качества будет состоять из терминальной стоимости $V_f (x(N|t))$ и суммарной стоимости переходного процесса, т.е. это будет критерий качества типа Больца. Терминальная стоимость будет рассмотрена ниже, при обсуждении терминальных элементов задачи ОУ. Стоимость переходного процесса для дискретных систем задается суммой стоимостей за каждый этап (для каждого $k\in \mathbb{I}_{[0,N-1]}$):
$$
    \sum_{k =0}^{N-1}l(x(k|t),u(k|t).
    $$
В литературе функция $l:\R^n \times \R^r \to \R$ называется стоимостью этапа (stage cost).

Относительно $l$ предполагается, что она непрерывна, а также:
\begin{enumerate}
\item  $l(x^*,u^*) = 0$, т.е. стоимость обращается в нуль в точке равновесия;
\item  согласно [2], $\exists$ функция $\alpha_1$ класса $\cal{K}_\infty$, что выполняется
\begin{equation*}
l(x,u) \geq \alpha_1(|x-x^*|)\ \forall (x,u) \in Z.
\end{equation*}
\end{enumerate}

Таким образом, прогнозирующая задача ОУ для момента времени $t$ имеет вид:
\begin{equation}\label{1OCP}
{\cal P}(t):\qquad	V(x(t)) = \min_{u(\cdot|t)} \ \sum_{k = 0}^{N-1}l(x(k|t),u(k|t)) + V_f (x(N|t)),
\end{equation}
при условиях
$$
    x(k+1|t) = f(x(k|t),u(k|t)) \ \ \forall\ k \in \mathbb{I}_{[0,N-1]},
    $$ 
$$  
    x(0|t)= x(t),
    $$
$$
    (x(k|t),u(k|t)) \in Z, \ \ \forall\ k \in \mathbb{I}_{[0,N-1]},
    $$
$$
    x(N|t) \in X_f.
    $$

В задаче (\ref{1OCP}) обсуждавшиеся выше "терминальные элементы":
\begin{itemize}
\item терминальная стоимость $V_f (x(N|t))$ в критерии качества;
\item терминальное ограничение $x(N|t)\in X_f$, где $X_f$ --- терминальное множество (terminal region).
\end{itemize}

Именно условия на эти элементы обеспечивают устойчивость замкнутой системы несмотря на то, что решается задача с конечным горизонтом (см. раздел~\ref{1sec:stability_system}).

Далее используем следующие обозначения: 
\\
$u^0 (\cdot|t) = \{u^0 (0|t),\ldots,u^0 (N-1|t)\}$ --- оптимальное (программное) управление  задачи ${\cal P}(t)$; \\
$x^0 (\cdot|t) = \{x^0 (0|t),\ldots,x^0 (N|t)\}$ --- соответствующая траектория;\\
$X_N$ --- множество всех состояний $x \in X$, для которых существует решение задачи (\ref{1OCP}) с $x(t) = x$.

\textbf{Базовый алгоритм MPC} состоит в следующем: \\
Для каждого $t \in \mathbb{I}_{\geq 0}$
\begin{enumerate}
\item измерить состояние $x(t) \in X$ системы (\ref{sys3});
\item решить задачу (\ref{1OCP}) с начальным условием $x(0|t) = x(t)$, получить ее решение $u^0 (\cdot|t)$;
\item подать на вход системы (\ref{sys3}) управляющее воздействие
\begin{equation}\label{1MPC-input}
    u_{MPC}(t):=u^0(0|t).	
\end{equation}
\end{enumerate}

Таким образом, в каждый момент $t \in \mathbb{I}_{\geq 0}$ на систему подается управляющее воздействие (\ref{1MPC-input}), которое неявно зависит от текущего состояния $x(t)$.
Соответственно, замкнутая система имеет вид
\begin{equation}\label{1MPC-closed}
    x(t+1) = f(x(t), u^0 (0|t)),\ t \in \mathbb{I}_{\geq 0}.
\end{equation}

После 20 лет исследований  теория MPC приобрела свои нынешние черты. Согласно \cite{FernandoFontes} все схемы номинального MPC описываются представленным базовым алгоритмом, а все прогнозирующие задачи ОУ в общем виде формулируются как (\ref{1OCP}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Терминальные элементы и устойчивость замкнyтой системы}\label{1sec:stability_system}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%(см., например, стр. 46 \cite{Mayne}).

Cхемы MPC зависят от выбора терминальных элементов $V_f$ и $X_f$.  Например, самые первые результаты исследований по MPC \cite{Mayne} были получены для состояния равновесия, совпадающего с началом координат $(x^*,u^*) = (0,0)$ (т.е. $f(0,0) = 0$) и предлагали использовать
$X_f= {0}$, т.е. терминальное условие принимало вид $x(N|t) = 0$. Сразу отметим, что ограничения-равенства считаются "плохими"{} с точки зрения вычислительных алгоритмов, поэтому дальнейшее развитие теории продолжалось в направлении ослабления этих простейших условий.

В частности, в работе \cite{FernandoFontes} приведены следующие общие условия, которым должны удовлетворять терминальное множество $X_f$ и терминальная стоимость $V_f$.  Эти условия , дополняют условия 1--2 на функцию стоимости этапа $l$ и имеют вид:
\begin{enumerate}
\item[3.] $V_f$ непрерывна;
\item[4.] терминальное множество $X_f$ замкнуто, $\{x^*\} \in X_f$;
\item[5.] существует локальная обратная связь $k_f: X_f \to U$, такая что для $\forall x \in X_f$ имеет место
\begin{enumerate}
\item[а)] $(x,k_f (x)) \in Z$. Это условие гарантирует допустимость локальной обратной связи  $k_f (x)$, $x \in X_f$.
\item[б)] $f(x,k_f (x)) \in X_f$. Это условие означает, что терминальное множество $X_f$ является положительно инвариантным для системы, замкнутой локальной обратной связью: $x(t+1) = f(x(t),k_f (x(t))) = g(x(t))$.
\item[в)] $V_f(f(x,k_f (x))) - V_f (x) \leq -l(x,k_f (x)) + l(x^*,u^*).$ Это условие вместе с условиями на $l$ означает, что терминальная стоимость $V_f$ может служить функцией Ляпунова на терминальном множестве $X_f$.
\end{enumerate}
\end{enumerate}

В работах \cite{Grune, Mayne} для дискретных систем можно найти следующий основной результат:

\begin{theorem}\label{theory1} Пусть $x_0 \in X_N$ и выполнены все предположения 1 --- 5 относительно функций $l,V_f$  и терминального множества $X_f$.
Тогда
\begin{enumerate}
\item замкнутая система \ref{1MPC-closed}, полученная в результате применения базового алгоритма, удовлетворяет ограничениям \ref{sys3} для всех $t \in \mathbb{I}_{\geq 0}$;

\item задача (\ref{1OCP}) имеет решение для всех $t \in \mathbb{I}_{\geq 0}$;

\item $x^*$ --- асимптотически устойчивое положение равновесия с областью притяжения  $X_N$.
\end{enumerate}
\end{theorem}

Выбор терминальных элементов зачастую зависит от задачи, однако существует общий подход к их нахождению и этот способ называется MPC на квази-бесконечном горизонте.

MPC на квази-бесконечном горизонте оптимизирует on-line функционал, состоящий
из стоимости на конечном горизонте и терминальной стоимости, при условиях динамичности системы,
входных ограничений и дополнительному ограничению на терминальное состояние. Выполнимость неравества для терминального
ограничения подразумевает под собой, что состояния в конце конечного горизонта будут находится в предписанном терминальном множестве. Терминальные состояния
штрафуются таким образом, что терминальная стоимость ограничивает стоимость на бесконечном горизонте для нелинейной системы, управляемой фиктивной
локальной линейной обратной связью. Если первое приближение системы стабилизируемо, то существует единственное решение уравнения Ляпунова, и тогда можно определить
терминальную функцию и множество off-line.

Рассмотрим первое приближение системы в начале координат
\begin{equation*}
    \dot x = f(x,u,t), x(t_0) = x_0
\end{equation*}
и получим линейную систему
\begin{equation*}\dot x = Ax + Bu \end{equation*}
где
$A =(\frac{\partial f}{\partial x})(0,0)$ и
$B =(\frac{\partial f}{\partial u})(0,0)$
Если уравнение можно стабилизировать, то линейная обратная связь для состояния
\begin{align*}
u &= Kx \\
A_K &= A+BK
\end{align*} асимптотически устойчива.


\begin{lemma}\label{lemma1}
Предположим, что первое приближение системы в начале координат стабилизируемое, тогда \cite{ChenAlgower}
\begin{enumerate}
\item уравнение Ляпунова
\begin{equation}\label{quasi_lyapunov}
(A_K+kI)^TP + P(A_K+kI) = - Q^*
\end{equation}
допускает единственную положительно определенную и симметричную матрицу P, где
 $Q^*=Q+K^TRK$ - положительно определенная и симметричная; $k \in [0, \infty)$ удовлетворяет $k < - \lambda_{max}(A_K)$.
\item $\exists \alpha \in (0, \infty)$ определяющая окрестность $\Omega_{\alpha}$ начала координат в форме  $\Omega_{\alpha} = \{x \in \mathbb{R}^n | x^TPx \leq \alpha\}$ такая что
 \begin{enumerate}
 \item $Kx \in U$, для $\forall x \in \Omega_{\alpha}$, т.е. линейный контроллер с обратной связью не нарушает входных ограничений в $\Omega_{\alpha}$
 \item $\Omega_{\alpha}$ инвариантно для нелинейных систем, контролируемых локальной линейной обратной связью $u=Kx$
 \item  для любого $x_1 \in \Omega_{\alpha}$, критерий качества для бесконечного горизонта $J^{\infty}(x_1, u)= \int_{t_1}^{\infty}(\|x(t)\|_Q^2+\|u(t)\|_R^2)dt$ ограничен таким образом:
 \begin{equation*}
 J^{\infty}(x_1, u) \leq x_1^TPx_1.
 \end{equation*}
 \end{enumerate} 
\end{enumerate}
\end{lemma}

Алгоритм нахождения терминальной функции и терминального множества
\begin{enumerate}
\item Найти линейную обратную связь $Kx$.
\item Выбрать константу $k \in [0, \infty)$, удовлетворяющую неравенству 
\begin{equation*}
k < - \lambda_{max}(A_K), 
\end{equation*}
и решить уравнение Ляпунова для нахождения $P$.
\item Найти наибольшую из возможных $\alpha_1$, такую что $Kx \in U$, для $\forall x \in \Omega_{\alpha_1}$.
\item Найти наибольшую из возможных $\alpha \in (0, \alpha_1)$, такую что неравенство
\begin{equation*}
	sup \left( \frac{\|f(x,Kx) - A_Kx\|}{\|x\|}| x \in \Omega_{\alpha} , x \neq 0 \right) \leq \frac{k\lambda_{min}(P)}{\|P\|}
\end{equation*}
удовлетворяется для $\Omega_{\alpha}$.
\end{enumerate}

\begin{theorem}
Допустим
\begin{enumerate}
\item $f: \mathbb{R}^n \times \mathbb{R}^m \to \mathbb{R}^n$ дважды дифференцируема, $f(0,0) = 0 \Rightarrow 0$ - точка равновесия системы с $u=0$
\item $U \subset \mathbb{R}^m$ компактно, выпукло и $0 \in int \ U$
\item $\exists$ решение задачи для любого начального $x_0 \in \mathbb{R}^n$, задача имеет кусочно непрервную $u(\cdot): [0,\infty) \to U$
\end{enumerate}
Если 1-3 предположения выполняются и
\begin{itemize}
\item первое приближение системы стабилизируемо
\item программируемое управление разрешимо в $t=0$
\end{itemize}
То замкнутая система асимптотически устойчива.
\end{theorem}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Выводы}\label{1sec:MPC-principles}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Основная идея алгоритма MPC состоит в том, чтобы в каждый момент времени оптимизировать будущее поведение системы  на конечном горизонте  и использовать первое значение полученного оптимального (программного) управления в качестве значения обратной связи для этого момента времени. Для аппроксимации бесконечного горизонта и смягчения терминальных ограничений используется MPC на квази-бесконечном горизонте. Однако главным недостатком данного классического метода MPC являются неэффективные вычисления,так как по алгоритму требуется решать оптимизационную задачу в каждый момент времени. Поэтому далее в работе предлагается вынести некоторые вычисления из классического MPC оффлайн, что позволит повысить производительность систем с прогнозирующей моделью.