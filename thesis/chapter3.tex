\chapter{Построение нейросетевого регулятора}

В данной магистерской диссертации рассматривается возможность вынесения вычисления оффлайн для нелинейных систем с прогнозирующей моделью. Как было показано в предыдущей главе более эффективное направление для этого типа задач является использование аппроксимаци закона управления. Для этого будут использоваться нейронные сети, как универсальный аппроксиматор непрерывных функций. 

В этой главе будут описаны эксперименты и результаты использования нейросетевых регуляторов, а также построение областей с помощью метода опорных векторов и будет проведено сравнение производительности для обычной процедуры MPC и нейросетвых регуляторов.

\section{Описание иллюстративного примера}
Рассмотрим нелинейную дискретную динамическую систему
\begin{equation} \label{general_task}
x(t+1) = f(x(t), u(t)),
\end{equation} 
где $x(t) \in \mathbb{R}^n$ - вектор состояний, $u(t) \in \mathbb{R}^m$ - вектор управления и $f(0,0) = 0$. Мы рассматриваем ограничения вида 
\begin{equation}\label{common_constraints}
X = \left \{  x \in \mathbb{R}^n | Hx \leq 1_p \right \}, \ U = \left \{ u \in \mathbb{R}^m | Lu \leq 1_q \right \}
\end{equation}


Также необходимо, чтобы выполнялось ограничение 
\begin{equation}
x(t), u(t)) \in X \times U \ \forall t \geq 0.
\end{equation} 

Будем оптимизировать функцию стоимости
\begin{equation}
min_{u(\cdot|t)} \sum_{k=0}^{N-1}l(x,u) + V_f(X(N)).
\end{equation}

Исследования будут проводиться на примере из  \cite{ParisiniZoppoli}.

Нелинейная система в дискретном виде представляет собой

\begin{equation}\label{example_mpc}
\dot{x}_1(t+1) = -x_2(t) + 0.5(1+ x_1(t))u(t)
\end{equation}
\begin{equation*}
\dot{x}_2(t+1) = x_1(t) + 0.5(1 - 4x_2(t))u(t)
\end{equation*}
с ограничениями
\begin{equation}\label{x_constraints}
x \in X = \{-2 \leq x_1 \leq 0.5, \ -1 \leq x_2 \leq 2\}
\end{equation}
\begin{equation}\label{u_constraints}
u \in U = \{-1 \leq u \leq 1\}
\end{equation}

Шаг дискретизации $\delta = 0.1$. Данная система имеет стабилизируемое первое приближение в начале координат, которое имеет вид
\begin{equation*}
x(t+1) = Ax(t) + Bu,  \ \ A = \begin{bmatrix}
   1 & -0.05 \\
    0.05 & 1
\end{bmatrix}, \ B = \begin{bmatrix}
   0.025 \\
    0.025
\end{bmatrix}.
\end{equation*}

Линейный локальный закон управления для терминального множества представляет собой $k_f(x(t)) = Kx(t) = \begin{bmatrix}
0.3799, & -0.4201
\end{bmatrix}x(t)$.

Параметры для терминального множества и функции посчитаны с помощью алгоритмов квази-бесконечного MPC из первой главы. Для данной системы функция качества имеет вид

\begin{equation}
V(x(t)) = \min_{u(\cdot|t)} \sum_{k=0}^{N-1}(||u(k|t)||^2 + 0.1||x(k|t)||^2) + V_f(x(t))
\end{equation}

где 
\begin{equation*}
V_f(x(t)) = x(t)^TPx(t) = x(t)^T\begin{bmatrix}
   48.3043 & -2.53 \\
    -2.53 & 70.8191
\end{bmatrix}x(t).
\end{equation*}

Терминальное множество задается в виде эллипсоида 
$$X_f = \{x \in \mathbb{R}^n | x(t)^TPx \leq \alpha\},$$
где $\alpha = 0.2129$. Таким образом, для системы определены все дизайн параметры для проведения процедуры MPC алгоритма. 
 
\section{Подход к решению}

Алгоритм MPC для стабилизации положения равновесия $x=0$ системы (\ref{general_task}) состоит в следующем:
Для каждого $t = 0, 1, \ldots$ \\
1. измерить состояние $x(t) \in X$ системы (1);\\
2. решить задачу (3) с начальным условием $x(0|t) = x(t)$, получить $u^0 (\cdot|t)$;\\
3. подать на вход системы (1) управляющее воздействие $u_{MPC}(x(t)):=u^0(0|t)$.

При выполнении ряда требований к функциям $l$, $V_f$ и множеству $X_f$ замкнутая система 
$$
    x(t+1) = f(x(t), u_{MPC}(x(t))), \ \ t=0,1, \ldots,
    $$
асимптотически устойчива с областью притяжения 
\begin{equation*}
X_0 = \{x_0: V(x_0)<+\infty\}\subseteq X,
\end{equation*}
состоящей из всех точек $x_0\in X$, для которых задача ${\cal P}(x_0)$ имеет решение [1, 2]. В первой главе приводится простой способ построения квадратичных функций $l$, $V_f$ и эллипсоида $X_f$, удовлетворяющих упомянутым условиям.

Мы будем рассматривать систему (\ref{example_mpc}) в контексте робастного MPC, так как аппроксимационная ошибка управления представляет собой отклонение для функции управления, а это и есть частный случай робастного MPC. 

В работе с использованием результатов \cite{HertnerKohler} исследуются условия, при которых, несмотря на ошибки аппроксимации, гарантируется выполнение ограничений  и асимптотическая устойчивость замкнутой системы. При выполнении следующих предположений для динамики $x(t+1) = f(x(t),u(t)) + d$, где $d$ --- допустимое отклонение для управления, можно гарантировать выше перечисленное:
\begin{enumerate}
\item  Локальная инкрементируемая стабилизуемость.Существует такая обратная связь $k: X \times X \times U \to \mathbb{R}^m$, $\delta$-функция Ляпунова $V_{\delta}: X \times X \times U \to \mathbb{R}_{\geq 0}$, которая непрерыная по первому аргументу и удовлетворяет $V_{\delta}(x,x,v) = 0 \ \forall x \in X, \ \forall v \in U$ и параметры $c_{\delta,\ l}$, $c_{\delta,\ u}$, $\delta_{loc}$, $k_{max} \in \mathbb{R} > 0$, $\rho \in (0,1)$, такие что следующие неравенства выполняются для $\forall (x,z,v) \in X \times X \times U,\ (z+,v+) \in X \times U$ с $V_{\delta}(x,z,v) \leq \delta_{loc}$:
\begin{equation*}
c_{\delta, l}||x-z||^2 \leq V_{\delta}(x,z,v) \geq c_{\delta, u},
\end{equation*} 
\begin{equation*}
||k(x,z,v) - v|| \geq k_{max}||x-z||,
\end{equation*}
\begin{equation*}
V_{\delta}(x^+, z^+,v^+) \geq \rho V_{\delta}(x,z,v)
\end{equation*}
для динамики $x^+ = f(x,k(x,z,v)), z^+ = f(z,v)$.
\item Локальная непрерывность по Липшицу. Существует $\lambda \in \mathbb{R}$, такая что при $\forall x \in X, \ \forall u \in U,\ \forall u+d \in U$ будет 
\begin{equation*}
||f(x,u+d) -f(x,u)|| \leq \lambda ||d||_{\infty}.
\end{equation*}
\item Ограничение на отклонение функции управления должен удовлетворять $\eta \leq \frac{1}{\lambda}\sqrt{\frac{\delta_{loc}}{c_{\delta, u}}}$.
\end{enumerate}

Для выполнения ограничений используются сужение ограничение в виде увеличивающейся трубки ограничений: чем ближе к началу координат,тем более увеличивающееся трубка для ограничений. Поэтому мы заменяем ограничения (\ref{common_constraints}) на суженные вида:
\begin{equation*}
\bar{X_k} = (1 - \epsilon_k)X = \{x \in \mathbb{R}^n: Hx \leq (1 - \epsilon_k)1_p\},
\end{equation*}
\begin{equation*}
\bar{U_k} = (1 - \epsilon_k)U = \{u \in \mathbb{R}^m : Lu \leq (1-\epsilon_k)1_q\}.
\end{equation*}
где 
\begin{equation*}
\epsilon_k = \epsilon(\frac{1-\sqrt{\rho}^k}{1-\sqrt{\rho}}), \ k \in \{0,1,...N\}, \ \epsilon = \eta \lambda \sqrt{\frac{c_{\delta, u}}{c_{\delta, l}}}max \{||H||_{\infty}, ||L||_{\infty}k_{max}\}.
\end{equation*}

Как отмечено выше, шаг 2 приведенного алгоритма может оказаться достаточно трудоемким. В связи с этим в настоящей работе предлагается вместо онлайн решения прогнозирующей задачи численными методами оптимального управления использовать  до начала процесса управления ряд методов машинного обучения, которые на основе обучающей выборки $(x, u_{MPC}(x))\in X\times U$ будут строить приближенные значения $\bar u_{MPC}(x(t))$ обратной связи $u_{MPC}(x)$, $x\in X$, для текущих состояний $x(t)$.

В настоящей работе применяются метод опорных векторов (Support Vector Machine, SVM) и нейронные сети. Метод опорных векторов с  радиальной базисной функции Гаусса \cite{Chakrabarty} используется, во-первых,  для выделения и аппроксимации области притяжения $X_0$ системы (\ref{general_task}). Это позволяет эффективно обрабатывать текущие состояния динамической системы и не допускать выход за пределы области притяжения при управлении с помощью приближенных обратных связей.  Во-вторых, метод опорных векторов применяется для многоклассовой классификации с целью выделения областей насыщения управления.  Наконец, в областях, в которых обратная связь $u_{MPC}$ принимает промежуточные значения, она аппроксимируется с использованием нейронной сети.

Обучение нейронной сети и классификация на основе SVM дает приближенное управления типа обратной связи $\bar u_{MPC}(x)$, $x\in X_0$. Система, замкнутая обратной связью $\bar u_{MPC}(x)$, $x\in X_0$, имеет вид
$$
    x (t + 1) = f (x (t), \bar u_{MPC}(x (t))), \ \ t = 0, 1, \ldots. \eqno(4)
    $$

Будет проводится сравнение приближенных законов управления, обученных на равномерной сетке, на сетке, полученной на основе равномерно распределенных последовательностей, и на случайной сетке с увеличением объема обучающей выборки в окрестности положения равновесия.  

\section{Базовая реализация нейросетевого регулятора}

После проведения стандартной процедуры MPC для системы (\ref{example_mpc}), описанной в главе 1 получилась следующая траектория для системы, представленная на рисунке \ref{fig:mpc_simple_trajectory}, полученная обратная связь $\bar u(t)$ представлена на рисунке \ref{fig:mpc_simple_control}. Горизонт планирования был взят $N=30$, т.е. мы планируем и высчитываем управления и состояния на $30$ шагов вперед.

Базовый вариант включает себя создание нейронной сети для аппроксимации обратной связи $\bar u(t)$ для данной системы. 
\begin{figure}[h]
\center{\includegraphics[scale=0.7]{mpc_simple}}
\caption{Полученная траектория для системы (\ref{example_mpc}) по стандартной процедуре MPC.}
\label{fig:mpc_simple_trajectory}
\end{figure}

\begin{figure}[h]
\center{\includegraphics[scale=0.7]{mpc_simple_control}}
\caption{Полученная обратная связь для системы (\ref{example_mpc}) по стандартной процедуре MPC.}
\label{fig:mpc_simple_control}
\end{figure}

Для построения аппроксимации обратной связи будет вычисляться обратная связь для состояний из равномерной сетки всех допустимых состояний из множества (\ref{x_constraints}) c шагом $0.05$. Для этих точек будет построено управление с помощью стандартной процедуры MPC и будет запоминаться только первое управление для этого состояния. На рисунке  \ref{fig:v_f} показано векторное поле сетки с шагом $0.1$, в котором видно как происходит переход из одного состояния в другое, используя полученные обратные связи. На рисунке видно, что для большинства точек следующее состояние находится в пределах допустимых значений, однако если взять некоторые точки где следующее состояние выходит за рамки нашего обучения, то мы можем получить нестабильное решение. 

\begin{figure}[h]
\center{\includegraphics[scale=0.7]{vector_field}}
\caption{Векторное поле для сетки с шагом $0.1$.}
\label{fig:v_f}
\end{figure}

Далее если посмотреть на рисунок \ref{fig:c_l}, то можно увидеть множество одинаковых управлений для состояний. Однако важно отметить, что сетка значений около начала координат должна быть достаточно детальной, чтобы не попасть в нестабильное положение управления.

\begin{figure}[h!]
\center{\includegraphics[scale=0.7]{control_law}}
\caption{Вычисленное управление для сетки значений состояний для обучения нейронной сети}
\label{fig:c_l}
\end{figure}

В работе \cite{ParisiniSanquineti} использовался итеративный процесс для поиска оптимального количества нейронов для скрытого слоя: выбирается начальное значение количества нейронов, затем строится сеть, которая аппроксимирует функцию и далее для каждого состояния сетки вычисляется значение аппроксимрованной обратной связи и обратной связи, полученной из стандартной процедуры MPC, если 
\begin{equation*}
||\bar u(t) - u^*(t)|| < \frac{\epsilon}{\sqrt{m}},
\end{equation*}
где $m$ --- размерности вектора управления. Для достижения точности $5 \cdot 10^{-3}$ понадобилось $25$ нейронов, в таблице \ref{tabular:approximation_accuracy} представлена зависимость точности от количества нейронов на скрытом слое.

\begin{table}
\caption{Таблица зависимости точности аппроксимации от количества нейронов на скрытом слое}
\label{tabular:approximation_accuracy}
\begin{center}
\begin{tabular}{|l|l|}
\hline 
Количество нейронов & Ошибка аппроксимации\\
\hline
5 & 0.021  \\
8 & 0.0092 \\
10 & 0.008 \\
15 & 0.0075 \\
20 & 0.0063 \\
25 & 0.0049 \\
\hline
\end{tabular}
\end{center}
\end{table}

На рисунке \ref{fig:trajectories} представлены траектории для задачи (\ref{example_mpc}), полученные при помощи стандартной процедуры MPC и при помощи построенного нейросетевого регулятора. Как видно из рисунка, получились достаточно близкие тракторие и они сошли к началу координат.

\begin{figure}[h!]
\center{\includegraphics[scale=0.7]{true_and_neuro_trajectory}}
\caption{Траектории, полученные при помощи стандартной процедуры MPC и нейросетевого регулятора}
\label{fig:trajectories}
\end{figure}

Для этого подхода необходимо вычислить значения управления в каждой точке сетки состояний для допустимых значений состояний. Далее обучается сеть на этих значениях,как задача обучения с учителем. Основные недостатки данного подхода:
\begin{itemize}
\item Необходимо брать достаточно много точек для хорошей аппроксимации, хотя иногда некоторые области имеют одинаковые значения и для них не надо вычислять заново управление,
\item Обучение и валидация проходят достаточно долго
\end{itemize}

Предполагаемые улучшения для этого подхода:
\begin{itemize}
\item Уменьшить кол-во генерируемых точек для гарантирования аппроксимации, рассмотреть генерирование точек с помощью стохастического подхода и стохастического с увелечением плотности точек у начала координат,
\item Вычислить $X_{0}$ --- область притяжения, множество состояний из которых, можно достигнуть начало координат,
\item Вычислить множество точек, для которых применяется насыщенное управление, для ускорения поиска управления в этих областях,
\item Рассмотреть возможность использования обучение без учителя и обучение с подкреплением для построения множества допустимых значений и закона управления 
\end{itemize}

\section{Построение области притяжения с помощью SVM}

При построении базового регулятора было замечено, что внутри области допустимых значений состояний есть область притяжения, множество точек, из которых можно достигнуть начало координат, и области, в которых могут быть нестабильные решения. Предлагается аппроксимировать область притяжения и только по точкам из области притяжения строить приближение для обратной связи.

Было сгенерировано $2000$ точек внутри области (\ref{x_constraints}) допустимых значений состояний с использованием квази-случайного метода построения с помощью множеств Хальтона. Для всех этих точек определяем возможность достижения из данного состояния точки начала координат. Помечаем состояние, из которого достижимо начало координат, с помощью пометки $1$, а нестабильное состояние как $-1$. Далее применяем метод SVM для аппроксимации области притяжения. В качестве функции ядра для метода SVM применяет радиальная функция Гаусса. 

После применения SVM для аппроксимации области притяжения, предсказанные пометки для точек из области достижимых значений представлены на рисунке \ref{fig:feasible_set_svm}. Также на рисунке отмечены опорные вектора, которые определяют область стабильных состояний.

\begin{figure}[h]
\center{\includegraphics[scale=0.8]{feas_set_svm}}
\caption{Аппроксимированная область притяжения для задачи (\ref{example_mpc}).}
\label{fig:feasible_set_svm}
\end{figure}

Для определения областей с насыщенными управлениями также воспользуемся методом SVM. Метод SVM хорошая работает для разграничения двух классов, а в нашей задачи у нас будет 3 класса, поэтому будем создавать две отдельные модели для аппроксимации областей: первую модель для определения области с управлением $u(t) = 1$ и вторую модель для определения области с управлением $u(t) = -1$. Для каждой модели мы помечаем те состояние, которые соответствует насыщенному управлению, как $1$б остальные состояния как $-1$. Однако в нашем случае мы будем использовать, как и описывалось ранее суживающиеся ограничения, поэтому вместо насыщенных равных граничным значениям, будем определять с зазором в $\epsilon $, т.е. пометим все состояния из которых будет управление $u(t) >= 1 - \epsilon$ либо $u(t) <= -1 + \epsilon$. Далее обучаем модели с помощью SVM с радиальной ядерной функцией Гаусса. 

На рисунке \ref{fig:feasible_sets_bounds} представлены области состояний, для которых необходимо применять насыщенные управления. Данные области помогут ускорить онлайн процедуру, так как теперь не нужно будет вычислять даже с помощью нейросетевого регулятора обратную связь для данных состояний, нужно будет только применять соответствующее насыщенное управление и не котроллировать выход аппроксимированного управления за границы допустимых значений. 

\begin{figure}[h!]
\centering
  \begin{tabular}{cc}
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.2\linewidth]{feasible_set_upper_bound_u}
    \caption{Аппроксимированная область применения $u(t) = 1$ для задачи (\ref{example_mpc}).}
  \end{subfigure}&
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.2\linewidth]{feasible_set_lower_bound_u}
    \caption{Аппроксимированная область применения $u(t) = -1$ для задачи (\ref{example_mpc}).}
  \end{subfigure}
  \end{tabular}
  \caption{Аппроксимированные области с насыщенным управлением.}
  \label{fig:feasible_sets_bounds}
\end{figure}

\section{Сравнение методов сэмплирования точек для построения аппроксимирования обратной связи}

В базовой реализации используется равномерная сетка для построения множества точек для аппроксимирования обратной связи. Однако для равномерной сетки нужно вычислить много точек,но не все они одинаково важны для построения обратной связи. Поэтому предлагается проверить сэмплирование точки стохастически и стохастически с увеличением плотности точек вокруг точки начала координат, так как вокруг точки начала координат, достаточно маленькие управления и аппроксимационный закон в этой зоне может вести не совсем хорошо. На равномерной сетке было взято $3000$ точек, поэтому исследовать другие способы сэмплирования на этом же количестве точек.

На рисунке \ref{fig:stochastic_points} представлены сэмплированные точки при стохастическом выборе $3000$ точек для области (\ref{x_constraints}) внутри области притяжения. 

\begin{figure}[h]
\center{\includegraphics[scale=0.5]{stochastic_points}}
\caption{Сэмплированные точки стохастически}
\label{fig:stochastic_points}
\end{figure}

На рисунке \ref{fig:stochastic_points_with_density_near_zero} представлены сэмплированные точки при стохастическом выборе $2600$ точек для области (\ref{x_constraints}) и $400$ точек сэмплированных из области округ начала координат $X_{zero} = \{(x_1,x_2): \|x_1\| \leq 0.2, \  \|x_2\| \leq 0.2\}$ внутри области притяжения. 

\begin{figure}[h]
\center{\includegraphics[scale=0.5]{stochastic_points_with_density_near_zero}}
\caption{Сэмплированные точки стохастически с увеличенной плотностью около нуля}
\label{fig:stochastic_points_with_density_near_zero}
\end{figure}

Ошибка аппроксимации для этих двух способов для выбранного количества нейронов на скрытом слое $n = 25$ представлена в таблице \ref{tabular:approximation_accuracy_type_sample}.

\begin{table}[h!]
\caption{Таблица зависимости точности аппроксимации от типа сэмплирования}
\label{tabular:approximation_accuracy_type_sample}
\begin{center}
\begin{tabular}{|p{10 cm}|l|}
\hline 
Тип сэмплирования & Ошибка аппроксимации\\
\hline
Равномерная сетка & 0.0051 \\
Стохастически сэмплированные точки & 0.0062 \\
Стохастически сэмплированные точки и увеличенная плотность точек около начала координат & 0.0039 \\
\hline
\end{tabular}
\end{center}
\end{table}

Как видно из таблицы \ref{tabular:approximation_accuracy_type_sample} при способе сэмплирования стохастически с увеличенной плотностью вокруг точки начала координат мы получаем выше точность ,чем при равномерной сетке и просто стохастическом способе.

Так как нам необходимо получить точность $5 \cdot 10^{-3}$, то можно уменьшить количество генрируемых точек. В таблице \ref{tabular:approximation_accuracy_number_points} представлены результаты аппроксимации для разного количества точек. Для получения заданной точности, мы можем генерировать $2500$ точек, а это значит можно сократить количество точек на $17\%$.

\begin{table}[h!]
\caption{Таблица зависимости точности аппроксимации от количества точек при сэмплировании стохастически и увеличенной плотности точек вокруг начала координат}
\label{tabular:approximation_accuracy_number_points}
\begin{center}
\begin{tabular}{|l|l|}
\hline 
Количество точек & Ошибка аппроксимации\\
\hline
3000 & 0.0039 \\
2800 & 0.0044 \\
2600 & 0.0047 \\
2500 & 0.0049 \\
\hline
\end{tabular}
\end{center}
\end{table}

\section{Сравнение результатов производительности}

Результаты производительности будут сравниваться для онлайн процедуры и построения и обучения оффлайн частей для решения задачи (\ref{example_mpc}).

В таблице \ref{tabular:time_vs_method} представлены значения времени в среднем для проведения одного шага алгоритма MPC онлайн. Для вычисления среднего значения времени было проведено $1000$ процедур вычисления первого шага процедуры MPC из различных начальных точек при помощи вышепредставленных методов. 

\begin{table}[h!]
\caption{Таблица зависимости времени проведения одного шага MPC от использованного метода}
\label{tabular:time_vs_method}
\begin{center}
\begin{tabular}{|p{10cm}|l|}
\hline 
Использованный метод & Время работы(мс)\\
\hline
Стандартная процедура MPC & 1240 \\
Нейросетевой регулятор & 55 \\
Нейросетевой регулятор с областями насыщенных управлений & 52\\
\hline
\end{tabular}
\end{center}
\end{table}

Как видно из таблицы последний метод незначительно выиграл у просто нейросетевого регулятора, однако по сравнению со стандартной процедурой было уменьшено время на один шаг MPC очень значительно, и составило уменьшение времени в $23$ раза.

В предыдущем пункте было рассмотрено проведение обучения на меньшем количестве точек за счет сэмплирования стохастически и увеличения плотности сэмплированных точек вокруг точки начала координат. Данный метод уменьшил время для обучения на $17\%$.

Однако стоит отметить,что несмотря на улучшения в уменьшениеи времени проведения одного шага теряется оптимальность траектории. Оптимальной траекторией считается в данном случае, траектория вычисленная при помощи стандартной процедуры MPC. Было подсчитано, что расхождения траекторий для $1000$ запусков из различных точек относительно оптимальных траекторий составили не более $16\%$. Однако эта потеря несущественна, так как главное,чтобы с помощью этого контроллера мы могли стабилизировать нашу систему и не выходили за рамки ограничений. Выигрыш по времени выполнения помогает быстро управлять системой и может быть использован в ряде производственных задач.

\section{Использование метода для задачи стабилизации обратного маятника}

Рассмотрим задачу стабилизации обратного маятника. Система линейна и представляется в таком виде:

\begin{equation}\label{pendulum_system}
\left[{\begin{array}{c}
  \dot{x}\\ \ddot{x}\\ \dot{\phi}\\ \ddot{\phi}
\end{array}}\right] =
\left[{\begin{array}{cccc}
  0&1&0&0\\
  0&\frac{-(I+ml^2)b}{I(M+m)+Mml^2}&\frac{m^2gl^2}{I(M+m)+Mml^2}&0\\
  0&0&0&1\\
  0&\frac{-mlb}{I(M+m)+Mml^2}&\frac{mgl(M+m)}{I(M+m)+Mml^2}&0
\end{array}}\right]
\left[{\begin{array}{c}
  x\\ \dot{x}\\ \phi\\ \dot{\phi}
\end{array}}\right]+
\end{equation}
\begin{equation*}
+ \left[{\begin{array}{c}0\\
  \frac{I+ml^2}{I(M+m)+Mml^2}\\
  0 \\
  \frac{ml}{I(M+m)+Mml^2}
\end{array}}\right]u,
\end{equation*}
где параметры системы задаются таким образом: 
$$M = 0.5, \ m = 0.2,\ b = 0.1,\ I = 0.006,\ g = 9.8,\ l = 0.3,$$
$$q = (M+m)\cdot(I+m \cdot l^2)-(m \cdot l)^2.$$

Ограничения накладываются только на угол $|\phi| \leq \frac{\pi}{3} $ и на управление $|u| \leq 200$.

Необходимо определить терминальные элементы для формулирования задачи в рамках квазибесконечного MPC. Линейная обратная связь в терминальной области представляет собой: 
\begin{equation*}
u_{loc}(t) = Kx(t) = [10.0000,   15.8365,  -79.1980,  -18.5048]x(t).
\end{equation*}
Терминальная функция --- квадратичная функция вида $x(t)^TPx(t)$, где 
\begin{equation*}
P = \left[{\begin{array}{cccc}
1.5979 &   0.7505 &  -1.8801 &  -0.3226 \\
    0.7505  &  0.9811 &  -2.6173 & -0.4276 \\
   -1.8801  & -2.6173  &  9.2988  &  1.2221 \\
   -0.3226 &  -0.4276 &  1.2221  &  0.2119
\end{array}}\right].
\end{equation*}

Будем использовать также как и в предыдущей задаче точность аппроксимации $\eta = 5 \cdot 10^{-3}$. 

Для построения датасета и дальнейшего анализа будем рассматривать следующую сетку значений состояний:
\begin{equation}\label{grid_state}
\left[{\begin{array}{c}
  x\\ \dot{x}\\ \phi\\ \dot{\phi}
\end{array}}\right] \leq \left[{\begin{array}{c}
  2\\ 2 \\ \frac{\pi}{3}\\ \frac{\pi}{3}
\end{array}}\right]
\end{equation}

Используя равномерную сетку значений с шагом $0.1$ мы получим $705600$ точек. Используя стохастическое сэмплирование, создадим датасет,состоящий из $585000$ точек. $50000$ точек будем сэмплировать из множества 
$$\{i \in {0,1,2,3}\ |\ |x(t,i)| \leq 0.2\}$$, это множество будет окрестностью нуля в которой мы хоти увеличить плотность точек для более точной аппроксимации. Оставшиеся точки будем сэмплировать из \ref{grid_state}. 

На этих двух датасетах мы должны обучить нейронную сеть для аппроксимации закона управления с точностью $\eta = 5 \cdot 10^{-3}$. Для достижения этой точности нам понадобилось $40$ нейронов на скрытом слое как для равномерной сетке, так и для стохастического сэмплирования, в таблице (\ref{tabular:approximation_accuracy_pendulum}) показаны значения ошибки в зависимости от количества нейронов на скрытом слое для двух сэмплированных датасетов.

\begin{table}[h!]
\caption{Таблица зависимости точности аппроксимации от количества нейронов на скрытом слое}
\label{tabular:approximation_accuracy_pendulum}
\begin{center}
\begin{tabular}{|l|l|l|}
\hline 
\thead{Количество нейронов} & \thead{Ошибка аппроксимации 
\\ (рамномерная сетка)} & \thead{Ошибка аппроксимации\\(стохастическое сэмплирование)}\\
\hline
5 & 1.5362  & 1.2145\\
10 & 0.2873  & 0.2712\\
15 & 0.1267 & 0.0934\\
20 & 0.0544 & 0.0511\\
25 & 0.0219 & 0.013\\
30 & 0.0081 & 0.0078\\
40 & 0.0049 & 0.0047\\
\hline
\end{tabular}
\end{center}
\end{table}

Область притяжения имеет вид, представленный на рисунке \ref{fig:feas_big_data}. Насыщенных управлений в данном датасете нет, поэтому области насыщенных управлений для этой задачи строить не будем.

\begin{figure}[h!]
\center{\includegraphics[scale=0.8]{feas_big_data}}
\caption{Область притяжения для задачи (\ref{pendulum_system})}
\label{fig:feas_big_data}
\end{figure}

Результат построенного нейросетевого регулятора представлен на рисунке \ref{fig:pendulum_res}. На рисунке показывается траектория MPC и нейросетевого регулятора,начиная из точки $x(t) = [0.35,0.35,0.35,0.35]$.

\begin{figure}[h!]
\centering
  \begin{tabular}{cc}
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.1\linewidth]{x1_x2}
    \caption{Траектория для обратного маятника на срезе для координат $x_1$ и $x_2$}
  \end{subfigure}&
  \begin{subfigure}[b]{0.45\textwidth}
    \includegraphics[width=1.1\linewidth]{x1_x3}
    \caption{Траектория для обратного маятника на срезе для координат $x_1$ и $x_3$}
  \end{subfigure}
  \end{tabular}
  \caption{Срезы траектория для стабилизации обратного маятника (\ref{pendulum_system})}
  \label{fig:pendulum_res}
\end{figure}

В таблице \ref{tabular:time_vs_method} представлены значения времени в среднем для проведения одного шага алгоритма MPC онлайн. Для вычисления среднего значения времени было проведено $1000$ процедур вычисления первого шага процедуры MPC из различных начальных точек при помощи вышепредставленных методов. При использовании стандартной процедуры MPC среднее значение времени вычисления одного равняется $1633$ мс, в то время как применение нейросетевого регулятора сокращает время выполнения одного шага до $78$ мс. 

\section{Модель аппроксимации системы с применением обучения с подкреплением}

\section{Выводы}

Выводы TO DO