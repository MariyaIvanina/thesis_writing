\chapter{Построение нейросетевого регулятора}

\section{Постановка задачи}
Рассмотрим нелинейную дискретную динамическую систему
\begin{equation} \label{general_task}
x(t+1) = f(x(t), u(t)),
\end{equation} 
где $x(t) \in \mathbb{R}^n$ - вектор состояний, $u(t) \in \mathbb{R}^m$ - вектор управления и $f(0,0) = 0$. Мы рассматриваем ограничения вида 
\begin{equation}
X = \left \{  x \in \mathbb{R}^n | Hx \leq 1_p \right \}, \ U = \left \{ u \in \mathbb{R}^m | Lu \leq 1_q \right \}
\end{equation}


Также необходимо, чтобы выполнялось ограничение 
\begin{equation}
x(t), u(t)) \in X \times U \ \forall t \geq 0.
\end{equation} 

Будем оптимизировать функцию стоимости
\begin{equation}
min_{u(\cdot|t)} \sum_{k=0}^{N-1}l(x,u) + V_f(X(N)).
\end{equation}

Исследования будут проводиться на примере из  \cite{ParisiniZoppoli}.

Нелинейная система в дискретном виде представляет собой

\begin{equation}\label{example_mpc}
x(t+1)_1 = x(t)_1 + \delta( -x(t)_2 + 0.5(1+ x(t)_1)u(t))
\end{equation}
\begin{equation*}
x(t+1)_2 = x(t)_2 + \delta( x(t)_1 + 0.5(1 - 4x(t)_2)u(t))
\end{equation*}
с ограничениями
\begin{equation}\label{x_constraints}
x \in X = \{-2 \leq x_1 \leq 0.5, \ -1 \leq x_2 \leq 2\}
\end{equation}
\begin{equation}\label{u_constraints}
u \in U = \{-2 \leq u \leq 2\}
\end{equation}

Шаг дискретизации $\delta = 0.1$. Данная система имеет стабилизируемое первое приближение в начале координат, которое имеет вид
\begin{equation*}
x(t+1) = Ax(t) + Bu,  \ \ A = \begin{bmatrix}
   1 & -0.05 \\
    0.05 & 1
\end{bmatrix}, \ B = \begin{bmatrix}
   0.025 \\
    0.025
\end{bmatrix}.
\end{equation*}

Линейный локальный закон управления для терминального множества представляет собой $k_f(x(t)) = Kx(t) = \begin{bmatrix}
0.3799, & -0.4201
\end{bmatrix}x(t)$.

Параметры для терминального множества и функции посчитаны с помощью алгоритмов квази-бесконечного MPC из первой главы. Для данной системы функция качества имеет вид

\begin{equation}
V(x(t)) = \min_{u(\cdot|t)} \sum_{k=0}^{N-1}(||u(k|t)||^2 + 0.1||x(k|t)||^2) + V_f(x(t))
\end{equation}

где 
\begin{equation*}
V_f(x(t)) = x(t)^TPx(t) = x(t)^T\begin{bmatrix}
   48.3043 & -2.53 \\
    -2.53 & 70.8191
\end{bmatrix}x(t).
\end{equation*}

Терминальное множество задается в виде эллипсоида 
$$X_f = \{x \in \mathbb{R}^n | x(t)^TPx \leq \alpha\},$$
где $\alpha = 0.2129$. Таким образом, для системы определены все дизайн параметры для проведения процедуры MPC алгоритма. 
 
\section{Подход к решению}

Алгоритм MPC для стабилизации положения равновесия $x=0$ системы (\ref{general_task}) состоит в следующем:
Для каждого $t = 0, 1, \ldots$ \\
1. измерить состояние $x(t) \in X$ системы (1);\\
2. решить задачу (3) с начальным условием $x(0|t) = x(t)$, получить $u^0 (\cdot|t)$;\\
3. подать на вход системы (1) управляющее воздействие $u_{MPC}(x(t)):=u^0(0|t)$.

При выполнении ряда требований к функциям $l$, $V_f$ и множеству $X_f$ замкнутая система 
$$
    x(t+1) = f(x(t), u_{MPC}(x(t))), \ \ t=0,1, \ldots,
    $$
асимптотически устойчива с областью притяжения $X_0 = \{x_0: V(x_0)<+\infty\}\subseteq X$, состоящей из всех точек $x_0\in X$, для которых задача ${\cal P}(x_0)$ имеет решение [1, 2]. В первой главе приводится простой способ построения квадратичных функций $l$, $V_f$ и эллипсоида $X_f$, удовлетворяющих упомянутым условиям.

Как отмечено выше, шаг 2 приведенного алгоритма может оказаться достаточно трудоемким. В связи с этим в настоящей работе предлагается вместо онлайн решения прогнозирующей задачи численными методами оптимального управления использовать  до начала процесса управления ряд методов машинного обучения, которые на основе обучающей выборки $(x, u_{MPC}(x))\in X\times U$ будут строить приближенные значения $\bar u_{MPC}(x(t))$ обратной связи $u_{MPC}(x)$, $x\in X$, для текущих состояний $x(t)$.

В настоящей работе применяются метод опорных векторов (Support Vector Machine, SVM) и нейронные сети. Метод опорных векторов с  радиальной базисной функции Гаусса \cite{Chakrabarty} используется, во-первых,  для выделения и аппроксимации области притяжения $X_0$ системы (\ref{general_task}). Это позволяет эффективно обрабатывать текущие состояния динамической системы и не допускать выход за пределы области притяжения при управлении с помощью приближенных обратных связей.  Во-вторых, метод опорных векторов применяется для многоклассовой классификации с целью выделения областей насыщения управления.  Наконец, в областях, в которых обратная связь $u_{MPC}$ принимает промежуточные значения, она аппроксимируется с использованием нейронной сети.

Обучение нейронной сети и классификация на основе SVM дает приближенное управления типа обратной связи $\bar u_{MPC}(x)$, $x\in X_0$. Система, замкнутая обратной связью $\bar u_{MPC}(x)$, $x\in X_0$, имеет вид
$$
    x (t + 1) = f (x (t), \bar u_{MPC}(x (t))), \ \ t = 0, 1, \ldots. \eqno(4)
    $$

В работе с использованием результатов \cite{Pin} исследуются условия, при которых, несмотря на ошибки аппроксимации, гарантируется выполнение ограничений  и асимптотическая устойчивость замкнутой системы. Кроме того, проводится сравнение приближенных законов управления, обученных на равномерной сетке, на сетке, полученной на основе равномерно распределенных последовательностей, и на случайной сетке с увеличением объема обучающей выборки в окрестности положения равновесия.  

\section{Базовая реализация нейросетевого регулятора}

После проведения стандартной процедуры MPC для системы (\ref{example_mpc}), описанной в главе 1 получилась следующая траектория для системы, представленная на рисунке \ref{fig:mpc_simple_trajectory}, полученная обратная связь $\bar u(t)$ представлена на рисунке \ref{fig:mpc_simple_control}. Горизонт планирования был взят $N=30$, т.е. мы планируем и высчитываем управления и состояния на $30$ шагов вперед.

Базовый вариант включает себя создание нейронной сети для аппроксимации обратной связи $\bar u(t)$ для данной системы. 
\begin{figure}[h]
\center{\includegraphics[scale=0.5]{mpc_simple}}
\caption{Полученная траектория для системы (\ref{example_mpc}) по стандартной процедуре MPC.}
\label{fig:mpc_simple_trajectory}
\end{figure}

\begin{figure}[h]
\center{\includegraphics[scale=0.5]{mpc_simple_control}}
\caption{Полученная обратная связь для системы (\ref{example_mpc}) по стандартной процедуре MPC.}
\label{fig:mpc_simple_control}
\end{figure}

Для построения аппроксимации обратной связи будет вычисляться обратная связь для состояний из равномерной сетки всех допустимых состояний из множества (\ref{x_constraints}) c шагом $0.05$. Для этих точек будет построено управление с помощью стандартной процедуры MPC и будет запоминаться только первое управление для этого состояния. На рисунке  \ref{fig:v_f} показано векторное поле сетки с шагом $0.1$, в котором видно как происходит переход из одного состояния в другое, используя полученные обратные связи. На рисунке видно, что для большинства точек следующее состояние находится в пределах допустимых значений, однако если взять некоторые точки где следующее состояние выходит за рамки нашего обучения, то мы можем получить нестабильное решение. Также на рисунке показана траектория полученная с помощью аппроксимированного закона управления, траектория была рассчитана из начального состояния $[-0.7, -0.8]$.

\begin{figure}[h]
\center{\includegraphics[scale=0.3]{vector_field}}
\caption{Векторное поле для сетки с шагом $0.1$.}
\label{fig:v_f}
\end{figure}

Далее если посмотреть на рисунок \ref{fig:c_l}, то можно увидеть множество одинаковых управлений для состояний. Однако важно отметить, что сетка значений около начала координат должна быть достаточно детальной, чтобы не попасть в нестабильное положение управления.

\begin{figure}[h]
\center{\includegraphics[scale=0.2]{control_law}}
\caption{Вычисленное управление для сетки значений состояний для обучения нейронной сети}
\label{fig:c_l}
\end{figure}

В работе \cite{ParisiniSanquineti} использовался итеративный процесс для поиска оптимального количества нейронов для скрытого слоя: выбирается начальное значение количества нейронов, затем строится сеть, которая аппроксимирует функцию и далее для каждого состояния сетки вычисляется значение аппроксимрованной обратной связи и обратной связи, полученной из стандартной процедуры MPC, если 
\begin{equation*}
||\bar u(t) - u^*(t)|| < \frac{\epsilon}{\sqrt{m}},
\end{equation*}
где $m$ --- размерности вектора управления. Для достижения точности $6*10^{-3}$ понадобилось $30$ нейронов, в таблице \ref{tabular:approximation_accuracy} представлена зависимость точности от количества нейронов на скрытом слое.

\begin{table}
\caption{Таблица зависимости точности аппроксимации от количества нейронов на скрытом слое}
\label{tabular:approximation_accuracy}
\begin{center}
\begin{tabular}{|l|l|}
\hline 
Количество нейронов & Ошибка аппроксимации\\
\hline
5 & 1.4  \\
8 & 0.98 \\
10 & 0.32 \\
15 & 0.067 \\
20 & 0.023 \\
30 & 0.006 \\
50 & 0.003 \\
\hline
\end{tabular}
\end{center}
\end{table}

Для этого подхода необходимо вычислить значения управления в каждой точке сетки состояний для допустимых значений состояний. Далее обучается сеть на этих значениях,как задача обучения с учителем. Основные недостатки данного подхода:
\begin{itemize}
\item Необходимо брать достаточно много точек для хорошей аппроксимации, хотя иногда некоторые области имеют одинаковые значения и для них не надо вычислять заново управление,
\item Обучение и валидация проходят достаточно долго
\end{itemize}

Предполагаемые улучшения для этого подхода:
\begin{itemize}
\item Уменьшить кол-во генерируемых точек для гарантирования аппроксимации, рассмотреть генерирование точек с помощью стохастического подхода и стохастического с увелечением плотности точек у начала координат,
\item Вычислить $X_{0}$ --- область притяжения, множество состояний из которых, можно достигнуть начало координат,
\item Вычислить множество точек, для которых применяется насыщенное управление, для ускорения поиска управления в этих областях,
\item Рассмотреть возможность использования обучение без учителя и обучение с подкреплением для построения множества допустимых значений и закона управления 
\end{itemize}

\section{Построение области притяжения с помощью SVM}

При построении базового регулятора было замечено, что внутри области допустимых значений состояний есть область притяжения, множество точек, из которых можно достигнуть начало координат, и области, в которых могут быть нестабильные решения. Предлагается аппроксимировать область притяжения и только по точкам из области притяжения строить приближение для обратной связи.

На равномерной сетке допустимых значений состояний с шагом $0.1$ определяем возможность достижения из данного состояния точки начала координат. Помечаем состояние, из которого достижимо начало координат, с помощью пометки $1$, а нестабильное состояние как $-1$. Далее применяем метод SVM для аппроксимации области притяжения. В качестве функции ядра для метода SVM применяет радиальная функция Гаусса. 

На рисунке \ref{fig:feas_set} изображено как были помечены точки из области допустимых значений для задачи (\ref{example_mpc}). 

\begin{figure}[h]
\center{\includegraphics[scale=0.6]{feas_set}}
\caption{Состояния, размеченные как стабильные и нестабильные.}
\label{fig:feas_set}
\end{figure}

После применения SVM для аппроксимации области притяжения, предсказанные пометки для точек из области достижимых значений представлены на рисунке \ref{fig:feasible_set_svm}. Также на рисунке отмечены опорные вектора, которые определяют область стабильных состояний.

\begin{figure}[h]
\center{\includegraphics[scale=0.7]{feasible_set_svm}}
\caption{Аппроксимированная область притяжения для задачи (\ref{example_mpc}).}
\label{fig:feasible_set_svm}
\end{figure}

Для определения областей с насыщенными управлениями также воспользуемся методом SVM. Метод SVM хорошая работает для разграничения двух классов, а в нашей задачи у нас будет 3 класса, поэтому будем создавать две отдельные модели для аппроксимации областей: первую модель для определения области с управлением $u(t) = 2$ и вторую модель для определения области с управлением $u(t) = -2$. Для каждой модели мы помечаем те состояние, которые соответствует насыщенному управлению как $1$, остальные состояния как $-1$.

На рисунке \ref{fig:feasible_set_upper_bound_u} - \ref{fig:feasible_set_lower_bound_u} представлены области состояний, для которых необходимо применять насыщенные управления. Данные области помогут ускорить онлайн процедуру, так как теперь не нужно будет вычислять даже с помощью нейросетевого регулятора обратную связь для данных состояний, нужно будет только применять соответствующее насыщенное управление. Также благодаря аппроксимации насыщенных управлений, не будет допускаться применение управления хотя бы не значительно превышающее границы допустимых управлений, ведь во время вычисления управления с помощью аппроксимации могут быть небольшие погрешности с выходом за границы. 

\begin{figure}[h]
\center{\includegraphics[scale=0.7]{feasible_set_upper_bound_u}}
\caption{Аппроксимированная область применения $u(t) = 2$ для задачи (\ref{example_mpc}).}
\label{fig:feasible_set_upper_bound_u}
\end{figure}

\begin{figure}[h]
\center{\includegraphics[scale=0.7]{feasible_set_lower_bound_u}}
\caption{Аппроксимированная область применения $u(t) = -2$ для задачи (\ref{example_mpc}).}
\label{fig:feasible_set_lower_bound_u}
\end{figure}

%\section{Сравнение методов сэмплирования точек для построения аппроксимирования обратной связи}

